<!DOCTYPE html>
<html>
<head>
    <title>Chylnx Hub Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Modern WhatsApp-like Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            height: 100vh;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Fixed Header Styles */
        header {
            background: #25D366;
            color: white;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(50px, 12vw, 60px);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 15px);
        }

        .header-info h2 {
            font-size: clamp(16px, 4vw, 20px);
        }

        .header-actions {
            display: flex;
            gap: clamp(15px, 3vw, 20px);
            font-size: clamp(16px, 4vw, 18px);
        }

        /* Updated Chat Container with Safe Margins */
        #chatContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path fill="%23007bff" d="M30,30 Q50,10 70,30 Q90,50 70,70 Q50,90 30,70 Q10,50 30,30 Z"/></svg>');
            background-color: #e5ddd5;
            margin-top: clamp(50px, 12vw, 60px);
            margin-bottom: clamp(60px, 15vw, 70px);
            height: calc(100vh - clamp(50px, 12vw, 60px) - clamp(60px, 15vw, 70px));
            position: relative;
            z-index: 1;
            padding-left: 10px;
            padding-right: 10px;
        }

        #chatWindow {
            flex: 1;
            padding: clamp(15px, 3vw, 20px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 2vw, 8px);
            height: 100%;
            position: relative;
            z-index: 10;
            margin-left: 0;
            margin-right: 0;
        }

        /* Updated Message Styles with Character-Safe Widths */
        .message {
            max-width: min(65%, 380px);
            padding: clamp(6px, 2vw, 8px) clamp(10px, 2vw, 12px);
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            z-index: 20;
            background: inherit;
            margin-left: 5px;
            margin-right: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: #dcf8c6;
            border-top-right-radius: 0;
            margin-right: 10px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
            margin-left: 10px;
        }

        .message-content {
            margin-bottom: 2px;
            line-height: 1.4;
            font-size: clamp(14px, 3vw, 16px);
            word-break: break-word;
            padding: 2px 0;
        }

        .message-time {
            font-size: clamp(10px, 2vw, 11px);
            color: #667781;
            text-align: right;
            margin-top: 2px;
        }

        .message.received .message-time {
            text-align: left;
        }

        .sender-name {
            font-weight: 600;
            color: #25D366;
            font-size: clamp(11px, 2.5vw, 13px);
            margin-bottom: 2px;
            cursor: pointer;
            position: relative;
            z-index: 25;
            transition: all 0.3s ease;
        }

        .sender-name:hover {
            text-decoration: underline;
        }

        .selected-sender .sender-name {
            background: rgba(37, 211, 102, 0.2);
            padding: 2px 6px;
            border-radius: 12px;
        }

        /* Fixed Input Area */
        #inputArea {
            background: #f0f0f0;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            border-top: 1px solid #d1d7db;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(60px, 15vw, 70px);
            z-index: 1000;
        }

        #chatInput {
            flex: 1;
            padding: clamp(10px, 2vw, 12px) clamp(12px, 3vw, 16px);
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: clamp(14px, 3vw, 15px);
            background: white;
            min-width: 0;
        }

        #sendBtn {
            background: #25D366;
            border: none;
            border-radius: 50%;
            width: clamp(35px, 10vw, 40px);
            height: clamp(35px, 10vw, 40px);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: clamp(14px, 3vw, 16px);
            flex-shrink: 0;
        }

        #sendBtn:hover {
            background: #20bd5a;
        }

        #sendBtn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }

        /* System messages with safe margins */
        .system-msg {
            text-align: center;
            color: #667781;
            font-size: clamp(12px, 2.5vw, 13px);
            margin: clamp(8px, 2vw, 10px) 20px;
            font-style: italic;
            padding: 0 10px;
        }

        /* Winner announcements with safe margins */
        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            text-align: center;
            padding: clamp(10px, 2vw, 12px);
            font-weight: bold;
            margin: clamp(8px, 2vw, 10px) 20px;
            border-radius: 8px;
            animation: winnerPulse 2s infinite;
            font-size: clamp(14px, 3vw, 16px);
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Overlays */
        #usernameOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667781 0%, #25D366 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #usernameForm {
            background: white;
            padding: clamp(25px, 6vw, 40px);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: min(400px, 95vw);
            margin: 20px;
        }

        #usernameForm h3 {
            margin-bottom: clamp(15px, 3vw, 20px);
            color: #333;
            font-size: clamp(18px, 4vw, 22px);
        }

        #usernameForm input {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: clamp(15px, 3vw, 20px);
            outline: none;
            transition: border-color 0.3s;
        }

        #usernameForm input:focus {
            border-color: #25D366;
        }

        #usernameForm button {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            cursor: pointer;
            transition: background 0.3s;
        }

        #usernameForm button:hover {
            background: #20bd5a;
        }

        .form-note {
            margin-top: clamp(15px, 3vw, 20px);
            color: #666;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        /* Scrollbar Styling */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }

        #chatWindow::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatWindow::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 3px;
        }

        /* Winner Selection Modal */
        #winnerModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .winner-modal-content {
            background: white;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 15px;
            text-align: center;
            max-width: min(400px, 90vw);
            margin: 20px;
        }

        .winner-modal-content h2 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 15px;
        }

        .winner-modal-content p {
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 20px;
        }

        .winner-modal-content button {
            padding: clamp(8px, 2vw, 10px) clamp(15px, 3vw, 20px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
        }

        /* Winner Announcement Overlay */
        #winnerAnnouncementOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            animation: fadeIn 0.5s ease-in;
        }

        .winner-announcement-content {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            padding: clamp(30px, 6vw, 50px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5);
            max-width: min(500px, 90vw);
            width: 100%;
            animation: scaleUp 0.5s ease-out, glow 2s infinite alternate;
            border: 3px solid #fff;
        }

        @keyframes scaleUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes glow {
            from { box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 10px 70px rgba(255, 215, 0, 0.8); }
        }

        .winner-announcement-content h2 {
            font-size: clamp(24px, 6vw, 36px);
            color: #000;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .winner-announcement-content p {
            font-size: clamp(20px, 5vw, 28px);
            color: #000;
            font-weight: bold;
            margin: 20px 0;
        }

        .winner-announcement-content .winner-trophy {
            font-size: clamp(40px, 10vw, 60px);
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Mobile-specific adjustments with safer margins */
        @media (max-width: 480px) {
            .message {
                max-width: 80% !important;
                margin-left: 8px;
                margin-right: 8px;
            }
            
            .message.sent {
                margin-right: 15px;
            }
            
            .message.received {
                margin-left: 15px;
            }
            
            #chatWindow {
                padding: 12px 8px !important;
            }
            
            #chatContainer {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .header-info {
                gap: 8px;
            }
            
            .header-actions {
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 75% !important;
            }
            
            #chatWindow {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        /* Extra small screens - even safer margins */
        @media (max-width: 320px) {
            .message {
                max-width: 70% !important;
                margin-left: 5px;
                margin-right: 5px;
            }
            
            .message.sent {
                margin-right: 8px;
            }
            
            .message.received {
                margin-left: 8px;
            }
            
            #chatWindow {
                padding: 8px 4px !important;
            }
            
            #chatContainer {
                padding-left: 2px;
                padding-right: 2px;
            }
            
            #usernameForm {
                padding: 20px 15px;
            }
        }

        /* Tablet screens */
        @media (min-width: 769px) and (max-width: 1024px) {
            .message {
                max-width: 70% !important;
            }
            
            #chatWindow {
                padding-left: 15px;
                padding-right: 15px;
            }
        }

        /* Large screens */
        @media (min-width: 1025px) {
            .message {
                max-width: 60% !important;
            }
            
            #chatWindow {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            #chatContainer {
                margin-top: 60px;
                margin-bottom: 70px;
            }
            
            header {
                padding: 10px 16px;
                height: 60px;
            }
            
            #inputArea {
                padding: 10px 16px;
                height: 70px;
            }
        }

        /* Mobile landscape mode - prevent character overlap */
        @media (max-height: 500px) and (orientation: landscape) {
            .message {
                max-width: 60% !important;
            }
            
            #chatWindow {
                padding: 10px 5px !important;
            }
            
            #chatContainer {
                padding-left: 5px;
                padding-right: 5px;
            }
        }

        /* Prevent horizontal scrolling */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Multiple Winner Selection Styles */
        .winner-selection-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .winner-panel-header {
            background: #25D366;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .winner-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .winner-list {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .winner-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .winner-item:hover {
            background: #f5f5f5;
        }

        .winner-item.selected {
            background: #e3f2fd;
        }

        .winner-checkbox {
            margin-right: 10px;
        }

        .winner-actions {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .winner-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #confirmWinners {
            background: #25D366;
            color: white;
        }

        #cancelWinners {
            background: #f0f0f0;
            color: #333;
        }

        .selected-count {
            background: #ffd700;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Selected username highlight in chat */
        .username-selected {
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #000 !important;
            font-weight: bold !important;
            padding: 3px 8px !important;
            border-radius: 15px !important;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5) !important;
            border: 2px solid #ff8c00 !important;
            animation: pulseGlow 2s infinite !important;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 2px 15px rgba(255, 215, 0, 0.8); }
        }

        /* Timer Block Message Styles */
        #usernameForm .timer-display {
            font-size: 2rem;
            color: #25D366;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(37, 211, 102, 0.5);
        }

        #usernameForm .waiting-message {
            color: #666;
            margin: 15px 0;
            line-height: 1.4;
        }

        #usernameForm .refresh-btn {
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        #usernameForm .refresh-btn:hover {
            background: #20bd5a;
        }

        #bell {
            font-size: 2rem;
            cursor: pointer;
            display: inline-block;
            animation: gentleSwing 4s ease-in-out infinite;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        #bell:hover {
            animation: excitedRing 0.4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px gold);
        }

        @keyframes gentleSwing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }

        @keyframes excitedRing {
            0%, 100% { transform: rotate(0deg) scale(1.2); }
            25% { transform: rotate(-12deg) scale(1.2); }
            75% { transform: rotate(12deg) scale(1.2); }
        }

        /* ===== UPDATED BOSS BABY STYLE CHARACTER ===== */
        .animated-character {
            position: fixed;
            z-index: 5;
            transition: all 1s ease-in-out;
            pointer-events: none;
            display: block !important;
            visibility: visible !important;
        }

        .character-body {
            position: relative;
            width: 120px;
            height: 160px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        /* Big Head like Boss Baby */
        .character-head {
            width: 80px;
            height: 75px;
            background: linear-gradient(135deg, #ffdbac 0%, #f1c27d 100%);
            border-radius: 45% 45% 50% 50%;
            margin: 0 auto 5px;
            position: relative;
            border: 2px solid #e0a96d;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Baseball Cap */
        .character-cap {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 25px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            border-radius: 50% 50% 0 0;
            z-index: 2;
        }

        .cap-bill {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 8px;
            background: #1e3a8a;
            border-radius: 4px;
        }

        .character-face {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 50%;
        }

        .character-eyes {
            position: absolute;
            top: 5px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 8px;
            transition: transform 0.3s ease;
            z-index: 3;
        }

        .eye {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            position: relative;
            border: 2px solid #333;
            animation: blink 4s infinite;
            overflow: hidden;
        }

        .eye::after {
            content: '';
            position: absolute;
            width: 7px;
            height: 7px;
            background: #333;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.2s ease;
        }

        /* Glasses */
        .character-glasses {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 20px;
            z-index: 4;
        }

        .glasses-frame {
            position: absolute;
            width: 45px;
            height: 18px;
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .glasses-bridge {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 2px;
            background: #333;
        }

        .character-mouth {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 6px;
            background: #e75480;
            border-radius: 0 0 8px 8px;
            transition: all 0.3s ease;
        }

        /* Nerdy Outfit - Button-up shirt and tie */
        .character-body-main {
            width: 65px;
            height: 55px;
            background: linear-gradient(135deg, #4a86e8 0%, #3a76d8 100%);
            border-radius: 20px 20px 15px 15px;
            margin: 0 auto;
            border: 2px solid #2c5aa0;
            position: relative;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2);
        }

        /* Shirt Collar */
        .shirt-collar {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 8px;
            background: #4a86e8;
            border-radius: 4px 4px 0 0;
        }

        /* Tie */
        .character-tie {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 25px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 0 0 4px 4px;
        }

        .tie-knot {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 8px;
            background: #c0392b;
            border-radius: 50%;
        }

        /* Arms - Dress shirt sleeves */
        .character-arm {
            position: absolute;
            width: 16px;
            background: linear-gradient(135deg, #4a86e8 0%, #3a76d8 100%);
            border: 2px solid #2c5aa0;
            border-radius: 10px;
            transition: all 0.5s ease;
            transform-origin: top center;
            box-shadow: inset -1px -1px 2px rgba(0,0,0,0.1);
        }

        .left-arm {
            height: 45px;
            top: 40px;
            left: -6px;
            transform: rotate(-25deg);
        }

        .right-arm {
            height: 45px;
            top: 40px;
            right: -6px;
            transform: rotate(25deg);
        }

        /* Legs - Dress pants */
        .character-leg {
            position: absolute;
            width: 18px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 2px solid #2c3e50;
            border-radius: 6px 6px 10px 10px;
            bottom: -35px;
            transform-origin: top center;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .left-leg {
            height: 35px;
            left: 16px;
        }

        .right-leg {
            height: 35px;
            right: 16px;
        }

        /* Speech Bubble */
        .speech-bubble {
            position: absolute;
            background: white;
            padding: 12px 18px;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: #333;
            max-width: 200px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            pointer-events: none;
            border: 2px solid #25D366;
            z-index: 10001;
            word-wrap: break-word;
            left: 50% !important;
            transform: translateX(-50%) !important;
        }

        .animated-character.username-guide .speech-bubble {
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
        }

        .animated-character.chat-guide .speech-bubble {
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            border: 12px solid transparent;
        }

        .animated-character.username-guide .speech-bubble::after {
            border-top-color: white;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .animated-character.chat-guide .speech-bubble::after {
            border-top-color: white;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Character positioning updates to ensure they stay in safe zones */
        .animated-character.username-guide {
            top: 40% !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translate(-50%, -50%) scale(0.8) !important;
            z-index: 5 !important;
            pointer-events: none;
        }

        .animated-character.chat-guide {
            bottom: 100px !important;
            left: 50% !important;
            right: auto !important;
            top: auto !important;
            transform: translateX(-50%) scale(0.7) !important;
            z-index: 5 !important;
            pointer-events: none;
        }

        /* Mobile speech bubble adjustments */
        @media (max-width: 768px) {
            .speech-bubble {
                max-width: 180px !important;
                font-size: 13px !important;
                padding: 10px 14px !important;
            }
            
            .animated-character.username-guide {
                transform: translate(-50%, -50%) scale(0.7) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 95px !important;
                transform: translateX(-50%) scale(0.6) !important;
            }
        }

        @media (max-width: 480px) {
            .speech-bubble {
                max-width: 160px !important;
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            .animated-character.username-guide {
                transform: translate(-50%, -50%) scale(0.6) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 90px !important;
                transform: translateX(-50%) scale(0.5) !important;
            }
        }

        /* Character Animations */
        @keyframes gentleSway {
            0%, 100% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(-3px) rotate(-1deg); }
            75% { transform: translateX(3px) rotate(1deg); }
        }

        @keyframes breathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes excitedJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes walk {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }

        @keyframes typing {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Active States */
        .animated-character.username-guide {
            animation: gentleSway 3s ease-in-out infinite, excitedJump 2s ease-in-out infinite;
        }

        .animated-character.username-guide .right-arm {
            animation: pointDown 2s ease-in-out infinite;
            transform: rotate(90deg);
        }

        .animated-character.chat-guide {
            animation: breathing 4s ease-in-out infinite;
        }

        .animated-character.chat-guide .character-head {
            animation: gentleSway 6s ease-in-out infinite;
        }

        /* Walking Animation for Transition */
        .animated-character.walking {
            animation: walk 0.6s ease-in-out infinite;
        }

        .animated-character.walking .left-leg {
            animation: walk 0.6s ease-in-out infinite;
        }

        .animated-character.walking .right-leg {
            animation: walk 0.6s ease-in-out infinite reverse;
        }

        /* Show speech bubble */
        .speech-bubble.show {
            opacity: 1;
            transform: translateY(0);
            animation: typing 0.5s ease-in-out;
        }

        /* Character Reactions */
        .character-talking .character-mouth {
            animation: talk 0.3s ease-in-out infinite;
        }

        @keyframes talk {
            0%, 100% { height: 4px; }
            50% { height: 8px; }
        }

        .character-excited {
            animation: excitedJump 0.5s ease-in-out 3 !important;
        }

        /* ===== DANCING ANIMATIONS ===== */
        .animated-character.dancing {
            animation: danceMove 1s ease-in-out infinite !important;
        }

        .animated-character.dancing .character-head {
            animation: headBob 0.5s ease-in-out infinite !important;
        }

        .animated-character.dancing .left-arm {
            animation: armWaveLeft 0.8s ease-in-out infinite !important;
        }

        .animated-character.dancing .right-arm {
            animation: armWaveRight 0.8s ease-in-out infinite !important;
        }

        .animated-character.dancing .left-leg {
            animation: legKickLeft 0.6s ease-in-out infinite !important;
        }

        .animated-character.dancing .right-leg {
            animation: legKickRight 0.6s ease-in-out infinite !important;
        }

        .animated-character.dancing .character-body-main {
            animation: bodyBounce 0.4s ease-in-out infinite !important;
        }

        .animated-character.dancing .speech-bubble {
            content: "🎉 CONGRATULATIONS! 🎉" !important;
            animation: bubbleCelebrate 0.5s ease-in-out infinite !important;
        }

        @keyframes danceMove {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            25% { transform: translateX(-50%) translateY(-10px) rotate(-5deg); }
            50% { transform: translateX(-50%) translateY(-5px) rotate(0deg); }
            75% { transform: translateX(-50%) translateY(-10px) rotate(5deg); }
        }

        @keyframes headBob {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(10deg); }
        }

        @keyframes armWaveLeft {
            0%, 100% { transform: rotate(-20deg); }
            50% { transform: rotate(60deg); }
        }

        @keyframes armWaveRight {
            0%, 100% { transform: rotate(20deg); }
            50% { transform: rotate(-60deg); }
        }

        @keyframes legKickLeft {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(30deg); }
        }

        @keyframes legKickRight {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-30deg); }
        }

        @keyframes bodyBounce {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.95); }
        }

        @keyframes bubbleCelebrate {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        /* Bell notification badge */
        .bell-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Ensure messages are above character on all screens */
        .message {
            position: relative;
            z-index: 20 !important;
            background: inherit !important;
            margin: 4px 0;
        }

        .message.sent {
            background: #dcf8c6 !important;
        }

        .message.received {
            background: white !important;
        }

        .sender-name {
            position: relative;
            z-index: 25 !important;
        }

        /* Mobile Keyboard Optimization */
        @media (max-height: 700px) {
            #chatContainer {
                margin-bottom: 50px !important;
            }
            
            .animated-character.chat-guide {
                bottom: 70px !important;
            }
            
            #inputArea {
                height: 50px !important;
            }
        }

        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #chatContainer {
                margin-top: 50px !important;
                margin-bottom: 45px !important;
            }
            
            header {
                height: 45px !important;
            }
            
            #inputArea {
                height: 45px !important;
            }
            
            .animated-character {
                display: block !important;
                visibility: visible !important;
            }
            
            .animated-character.username-guide {
                top: 50% !important;
                transform: translate(-50%, -50%) scale(0.5) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 70px !important;
                transform: translateX(-50%) scale(0.45) !important;
            }
        }

        /* Touch-friendly button sizes for mobile */
        #sendBtn {
            min-width: 40px;
            min-height: 40px;
        }

        #chatInput {
            min-height: 40px;
        }

        /* Fix for character display - ALWAYS VISIBLE */
        #animatedCharacter {
            display: block !important;
            visibility: visible !important;
        }
         /* ALL YOUR EXISTING CSS STAYS EXACTLY THE SAME */
        /* ... [Your complete CSS remains here] ... */

        /* Add timer block styles */
        .timer-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .timer-block-content {
            background: linear-gradient(135deg, #25D366, #128C7E);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
        }

        .timer-block-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: white;
        }

        .timer-block-content p {
            font-size: 1.2rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .game-countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #ffcc00;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
        }

        .waiting-message {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 20px;
        }
          /* ALL YOUR EXISTING CSS STAYS EXACTLY THE SAME */
        /* ... [Your complete CSS remains here] ... */

        /* Add timer block styles */
        .timer-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .timer-block-content {
            background: linear-gradient(135deg, #25D366, #128C7E);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
        }

        .timer-block-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: white;
        }

        .timer-block-content p {
            font-size: 1.2rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .game-countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #ffcc00;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
        }

        .waiting-message {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 20px;
        }

        /* FIXED CHAT LAYOUT FOR MOBILE - ADDED */
        body {
            height: 100vh;
            overflow: hidden; /* Prevent body scrolling */
        }

        #chatContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path fill="%23007bff" d="M30,30 Q50,10 70,30 Q90,50 70,70 Q50,90 30,70 Q10,50 30,30 Z"/></svg>');
            background-color: #e5ddd5;
            margin-top: clamp(50px, 12vw, 60px);
            margin-bottom: clamp(60px, 15vw, 70px);
            height: calc(100vh - clamp(50px, 12vw, 60px) - clamp(60px, 15vw, 70px));
            position: relative;
            z-index: 1;
            padding-left: 10px;
            padding-right: 10px;
            overflow: hidden; /* Prevent container scrolling */
        }

        #chatWindow {
            flex: 1;
            padding: clamp(15px, 3vw, 20px);
            overflow-y: auto; /* Only chat window scrolls when needed */
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 2vw, 8px);
            height: 100%;
            position: relative;
            z-index: 10;
            margin-left: 0;
            margin-right: 0;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Improved mobile input area */
        #inputArea {
            background: #f0f0f0;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            border-top: 1px solid #d1d7db;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(60px, 15vw, 70px);
            z-index: 1000;
            /* Prevent layout shift on mobile */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        /* Better mobile keyboard handling */
        @media (max-width: 768px) {
            body.keyboard-open #chatContainer {
                height: calc(100vh - clamp(50px, 12vw, 60px) - clamp(60px, 15vw, 70px) - 300px);
            }
            
            body.keyboard-open #inputArea {
                position: fixed;
                bottom: 0;
            }
            
            /* Ensure messages are visible when keyboard is open */
            body.keyboard-open #chatWindow {
                padding-bottom: 20px;
            }
        }

        /* Extra small screen optimizations */
        @media (max-width: 480px) {
            #chatContainer {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            #chatWindow {
                padding: 10px 5px;
            }
            
            .message {
                max-width: 85% !important;
                margin-left: 3px;
                margin-right: 3px;
            }
        }

        /* Prevent zoom on input focus for iOS */
        @media (max-width: 768px) {
            #chatInput {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

      /* Realistic walking animations */
.animated-character.walking .left-leg {
    animation: realisticWalkLeft 0.6s ease-in-out infinite;
    transform-origin: top center;
}

.animated-character.walking .right-leg {
    animation: realisticWalkRight 0.6s ease-in-out infinite;
    transform-origin: top center;
}

.animated-character.walking .left-arm {
    animation: realisticArmLeft 0.6s ease-in-out infinite;
    transform-origin: top center;
}

.animated-character.walking .right-arm {
    animation: realisticArmRight 0.6s ease-in-out infinite;
    transform-origin: top center;
}

.animated-character.walking .character-body-main {
    animation: bodySway 0.6s ease-in-out infinite;
}

.animated-character.walking .character-head {
    animation: headBob 0.6s ease-in-out infinite;
}

@keyframes realisticWalkLeft {
    0%, 100% { 
        transform: rotate(0deg) translateY(0px);
    }
    25% { 
        transform: rotate(15deg) translateY(-2px);
    }
    50% { 
        transform: rotate(0deg) translateY(0px);
    }
    75% { 
        transform: rotate(-10deg) translateY(2px);
    }
}

@keyframes realisticWalkRight {
    0%, 100% { 
        transform: rotate(0deg) translateY(0px);
    }
    25% { 
        transform: rotate(-15deg) translateY(-2px);
    }
    50% { 
        transform: rotate(0deg) translateY(0px);
    }
    75% { 
        transform: rotate(10deg) translateY(2px);
    }
}

@keyframes realisticArmLeft {
    0%, 100% { 
        transform: rotate(-20deg);
    }
    50% { 
        transform: rotate(10deg);
    }
}

@keyframes realisticArmRight {
    0%, 100% { 
        transform: rotate(20deg);
    }
    50% { 
        transform: rotate(-10deg);
    }
}

@keyframes bodySway {
    0%, 100% { 
        transform: translateX(0px) rotate(0deg);
    }
    25% { 
        transform: translateX(-1px) rotate(-0.5deg);
    }
    75% { 
        transform: translateX(1px) rotate(0.5deg);
    }
}

@keyframes headBob {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg);
    }
    50% { 
        transform: translateY(-1px) rotate(0.5deg);
    }
}

/* Smooth transitions for character */
.animated-character {
    transform-origin: center bottom;
    transition: transform 0.2s ease, bottom 0.2s ease;
}

/* Standing pose when not walking */
.animated-character:not(.walking) .left-leg,
.animated-character:not(.walking) .right-leg {
    animation: none;
    transform: rotate(0deg);
}

.animated-character:not(.walking) .left-arm {
    animation: none;
    transform: rotate(-25deg);
}

.animated-character:not(.walking) .right-arm {
    animation: none;
    transform: rotate(25deg);
}
    </style>
</head>
<body data-paid="false">
    <!-- REMOVED MUSIC CONTROLS -->

    <!-- REST OF YOUR HTML (UNCHANGED) -->
    <div id="timerBlockOverlay" class="timer-block-overlay" style="display: none;">
        <div class="timer-block-content">
            <h2>⏰ WAIT TILL TIMER ENDS </h2>
            <p>Please wait for the timer to end to start game </p>
            <div class="game-countdown" id="gameTimerDisplay">05:00</div>
            <p>You'll be able to join chat once timer is completed</p>
            <div class="waiting-message">
                🔄 This page will refresh automatically when the timer ends
            </div>
        </div>
    </div>

    <div id="winnerSelectionPanel" class="winner-selection-panel">
        <div class="winner-panel-header">
            <h3>Select Winners <span id="selectedCount" class="selected-count">0</span></h3>
            <span onclick="closeWinnerPanel()" style="cursor: pointer; font-size: 18px;">×</span>
        </div>
        <div class="winner-list" id="winnerList"></div>
        <div class="winner-actions">
            <button id="cancelWinners" onclick="closeWinnerPanel()">Cancel</button>
            <button id="confirmWinners" onclick="announceSelectedWinners()">Announce Winners</button>
        </div>
    </div>

    <div id="usernameOverlay">
        <div id="usernameForm">
            <h3>Join the Chat</h3>
            <input type="text" id="usernameInput" placeholder="Enter your username" autocomplete="off">
            <button onclick="setUsername()">Start Chatting</button>
            <div class="form-note">Choose a cool name to get started!</div>
        </div>
    </div>

    <header>
        <div class="header-info">
            <h2>💬 Chylnx Chat</h2>
            <span id="onlineCount">Loading...</span>
        </div>
        <div class="header-actions">
            <span id="bellContainer" style="position: relative;">
                <span id="bell" title="Announce Winner">🔔</span>
                <span id="bellNotification" class="bell-notification" style="display: none;">0</span>
            </span>
        </div>
    </header>

    <div id="chatContainer">
        <div id="chatWindow">
            <div class="system-msg">Welcome to the chat! Type a message to begin.</div>
        </div>
    </div>

    <div id="inputArea">
        <input id="chatInput" type="text" placeholder="Type a message..." disabled>
        <button id="sendBtn" disabled>➤</button>
    </div>

    <div class="animated-character username-guide" id="animatedCharacter">
        <div class="character-body">
            <div class="character-head">
                <div class="character-cap">
                    <div class="cap-bill"></div>
                </div>
                <div class="character-face">
                    <div class="character-glasses">
                        <div class="glasses-frame"></div>
                        <div class="glasses-bridge"></div>
                    </div>
                    <div class="character-eyes">
                        <div class="eye left-eye"></div>
                        <div class="eye right-eye"></div>
                    </div>
                    <div class="character-mouth"></div>
                </div>
            </div>
            <div class="character-body-main">
                <div class="shirt-collar"></div>
                <div class="character-tie">
                    <div class="tie-knot"></div>
                </div>
            </div>
            <div class="character-arm left-arm"></div>
            <div class="character-arm right-arm"></div>
            <div class="character-leg left-leg"></div>
            <div class="character-leg right-leg"></div>
        </div>
        <div class="speech-bubble show" id="speechBubble">INPUT A COOL USERNAME! 🎮</div>
    </div>

    <div id="winnerModal">
        <div class="winner-modal-content">
            <h2>🎉 Winner Selected! 🎉</h2>
            <p id="winnerMessage">THE WINNER IS: <span id="winnerName"></span></p>
            <button onclick="closeWinnerModal()">Close</button>
        </div>
    </div>

    <div id="winnerAnnouncementOverlay">
        <div class="winner-announcement-content">
            <div class="winner-trophy">🏆</div>
            <h2>WINNER ANNOUNCED!</h2>
            <p>CONGRATULATIONS TO:</p>
            <p id="announcedWinnerName" style="font-size: clamp(24px, 6vw, 32px); color: #000; font-weight: bold;"></p>
            <p style="margin-top: 20px; font-size: clamp(14px, 3vw, 18px);">This announcement will close automatically</p>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // FIXED CHAT CODE - Music Function Removed
        let myUsername = "";
        let socket = null;
        let selectedWinners = [];
        let onlineUsers = [];
        let isGameStarted = false;
        let characterState = 'username';
        const ANNOUNCE_PASSCODE = "1234";
        let messageInterval;
        let characterAnimationInterval;
        let gameTimerInterval;
        let gameTimeRemaining = 0;
        let isUserTyping = false;
        let typingTimeout;
        let walkingAnimationInterval;

        function initApp() {
            console.log('🚀 Initializing app...');
            
            // Show username overlay but check timer first
            document.getElementById('usernameOverlay').style.display = 'flex';
            
            // Initialize character
            initializeCharacter();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup mobile keyboard handling
            setupMobileKeyboard();
            
            // Setup typing detection
            setupTypingDetection();
            
            // Check timer status
            checkTimerStatus();
            
            console.log('✅ App initialized successfully');
        }

        // MOBILE KEYBOARD HANDLING
        function setupMobileKeyboard() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            
            chatInput.addEventListener('focus', function() {
                if (window.innerWidth <= 768) {
                    document.body.classList.add('keyboard-open');
                    setTimeout(() => {
                        const chatWindow = document.getElementById('chatWindow');
                        if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
                    }, 300);
                }
            });
            
            chatInput.addEventListener('blur', function() {
                document.body.classList.remove('keyboard-open');
            });
            
            chatInput.addEventListener('touchstart', function(e) {
                if (window.innerWidth <= 768) e.stopPropagation();
            });
        }

        // TIMER FUNCTIONS
        function checkTimerStatus() {
            const tempSocket = io();
            tempSocket.on('connect', function() {
                console.log('⏰ Checking timer status...');
                tempSocket.emit('get_timer');
            });
            
            tempSocket.on('timer_update', function(data) {
                console.log('📡 Timer status received:', data);
                if (data.is_running && data.remaining_seconds > 0) {
                    gameTimeRemaining = data.remaining_seconds;
                    showTimerBlock();
                    startGameTimerCountdown();
                } else {
                    isGameStarted = true;
                    hideTimerBlock();
                }
                tempSocket.disconnect();
            });
            
            tempSocket.on('game_started', function(data) {
                console.log('🎉 Game started - allowing username entry');
                isGameStarted = true;
                hideTimerBlock();
                tempSocket.disconnect();
            });
            
            tempSocket.on('connect_error', function(error) {
                console.error('❌ Connection error:', error);
                isGameStarted = true;
                hideTimerBlock();
            });
        }

        function showTimerBlock() {
            const timerBlock = document.getElementById('timerBlockOverlay');
            const usernameOverlay = document.getElementById('usernameOverlay');
            if (timerBlock) timerBlock.style.display = 'flex';
            if (usernameOverlay) usernameOverlay.style.display = 'none';
        }

        function hideTimerBlock() {
            const timerBlock = document.getElementById('timerBlockOverlay');
            const usernameOverlay = document.getElementById('usernameOverlay');
            if (timerBlock) timerBlock.style.display = 'none';
            if (usernameOverlay && !myUsername) usernameOverlay.style.display = 'flex';
        }

        function startGameTimerCountdown() {
            clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                if (gameTimeRemaining <= 0) {
                    clearInterval(gameTimerInterval);
                    isGameStarted = true;
                    hideTimerBlock();
                    return;
                }
                gameTimeRemaining--;
                updateGameTimerDisplay();
            }, 1000);
            updateGameTimerDisplay();
        }

        function updateGameTimerDisplay() {
            const timerDisplay = document.getElementById('gameTimerDisplay');
            if (timerDisplay) {
                const minutes = Math.floor(gameTimeRemaining / 60);
                const seconds = gameTimeRemaining % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function setupEventListeners() {
            const sendBtn = document.getElementById('sendBtn');
            const chatInput = document.getElementById('chatInput');
            const bell = document.getElementById('bell');
            const usernameInput = document.getElementById('usernameInput');
            
            if (sendBtn) sendBtn.addEventListener('click', sendMessage);
            if (chatInput) chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            if (bell) bell.addEventListener('click', showWinnerSelectionPanel);
            if (usernameInput) usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') setUsername();
            });
        }

        // CHARACTER FUNCTIONS
        function initializeCharacter() {
            const character = document.getElementById('animatedCharacter');
            if (!character) return;
            character.style.display = 'block';
            character.style.visibility = 'visible';
            showUsernameGuide();
            startCharacterAnimations();
        }

        function startCharacterAnimations() {
            const character = document.getElementById('animatedCharacter');
            if (!character) return;
            if (messageInterval) clearInterval(messageInterval);
            messageInterval = setInterval(() => {
                if (characterState === 'username') animateUsernameCharacter();
                else if (characterState === 'chat') animateChatCharacter();
            }, 3000);
        }

        function animateUsernameCharacter() {
            const speechBubble = document.getElementById('speechBubble');
            const character = document.getElementById('animatedCharacter');
            const mouth = character?.querySelector('.character-mouth');
            const eyes = character?.querySelector('.character-eyes');
            
            if (!speechBubble) return;
            const messages = [
                "INPUT A COOL USERNAME! 🎮", "CHOOSE AN AWESOME NAME! ✨", 
                "PICK A CREATIVE USERNAME! 🚀", "ENTER YOUR COOL NAME! 💫", 
                "WHAT'S YOUR GAMER TAG? 🎯"
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            speechBubble.textContent = randomMessage;
            speechBubble.classList.add('show');
            
            if (mouth) {
                mouth.style.height = '8px';
                setTimeout(() => { if(mouth) mouth.style.height = '6px'; }, 500);
            }
            
            if (eyes && Math.random() > 0.5) {
                const randomX = (Math.random() - 0.5) * 10;
                eyes.style.transform = `translateX(${randomX}px)`;
                setTimeout(() => { if(eyes) eyes.style.transform = 'translateX(0)'; }, 1000);
            }
        }

        function setupMessageFollowing() {
            const chatWindow = document.getElementById('chatWindow');
            const character = document.getElementById('animatedCharacter');
            if (!chatWindow || !character) return;
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.classList && (node.classList.contains('message') || node.classList.contains('system-msg'))) {
                                followMessage(node);
                            }
                        });
                    }
                });
            });
            observer.observe(chatWindow, { childList: true });
        }

        function followMessage(messageElement) {
            const character = document.getElementById('animatedCharacter');
            const eyes = character?.querySelector('.character-eyes');
            if (!character || !eyes) return;
            
            const messageRect = messageElement.getBoundingClientRect();
            const characterRect = character.getBoundingClientRect();
            const messageCenterX = messageRect.left + messageRect.width / 2;
            const characterCenterX = characterRect.left + characterRect.width / 2;
            const deltaX = messageCenterX - characterCenterX;
            const eyeMovement = Math.min(Math.max(deltaX / 50, -15), 15);
            eyes.style.transform = `translateX(${eyeMovement}px)`;
            characterReactToMessage(messageElement.classList.contains('sent'));
        }

        function animateChatCharacter() {
            const character = document.getElementById('animatedCharacter');
            const eyes = character?.querySelector('.character-eyes');
            const mouth = character?.querySelector('.character-mouth');
            if (!character) return;
            
            if (eyes && Math.random() > 0.7) {
                const randomX = (Math.random() - 0.5) * 8;
                eyes.style.transform = `translateX(${randomX}px)`;
                setTimeout(() => { if(eyes) eyes.style.transform = 'translateX(0)'; }, 2000);
            }
            
            if (mouth && Math.random() > 0.8) {
                mouth.style.height = '4px';
                setTimeout(() => { if(mouth) mouth.style.height = '6px'; }, 300);
            }
        }

        function showUsernameGuide() {
            const character = document.getElementById('animatedCharacter');
            const speechBubble = document.getElementById('speechBubble');
            if (!character) return;
            
            characterState = 'username';
            character.className = 'animated-character username-guide';
            character.style.display = 'block';
            character.style.visibility = 'visible';
            character.style.top = '40%';
            character.style.left = '50%';
            character.style.right = 'auto';
            character.style.bottom = 'auto';
            character.style.transform = 'translate(-50%, -50%) scale(0.8)';
            
            if (speechBubble) {
                speechBubble.textContent = 'INPUT A COOL USERNAME! 🎮';
                speechBubble.classList.add('show');
            }
        }

        function showChatGuide() {
            const character = document.getElementById('animatedCharacter');
            const speechBubble = document.getElementById('speechBubble');
            if (!character) return;
            
            characterState = 'chat';
            character.className = 'animated-character chat-guide';
            const isMobile = window.innerWidth <= 768;
            const bottomPosition = isMobile ? '85px' : '90px';
            const scale = isMobile ? '0.6' : '0.7';
            const chatContainer = document.getElementById('chatContainer');
            const chatRect = chatContainer.getBoundingClientRect();
            const centerX = (chatRect.width - 120) / 2;
            
            character.style.bottom = bottomPosition;
            character.style.left = '0px';
            character.style.right = 'auto';
            character.style.top = 'auto';
            character.style.transform = `translateX(${centerX}px) scale(${scale})`;
            character.style.zIndex = '5';
            stopWalkingAnimation();
            setupMessageFollowing();
            
            if (speechBubble) {
                speechBubble.textContent = 'Welcome to the chat! Start typing.';
                speechBubble.classList.add('show');
                setTimeout(() => speechBubble.classList.remove('show'), 5000);
            }
        }

        function characterReactToMessage(isMyMessage) {
            if (characterState !== 'chat') return;
            const character = document.getElementById('animatedCharacter');
            const speechBubble = document.getElementById('speechBubble');
            const mouth = character?.querySelector('.character-mouth');
            const rightArm = character?.querySelector('.right-arm');
            const leftArm = character?.querySelector('.left-arm');
            if (!character) return;
            
            if (isMyMessage) {
                if (rightArm) rightArm.style.transform = 'rotate(60deg)';
                if (mouth) mouth.style.height = '8px';
                if (speechBubble) {
                    const reactions = ["Message sent! 📤", "Nice one! 👍", "Great message! 🚀"];
                    speechBubble.textContent = reactions[Math.floor(Math.random() * reactions.length)];
                    speechBubble.classList.add('show');
                }
                setTimeout(() => {
                    if (rightArm) rightArm.style.transform = 'rotate(25deg)';
                    if (mouth) mouth.style.height = '6px';
                    setTimeout(() => { if (speechBubble) speechBubble.classList.remove('show'); }, 2000);
                }, 1000);
            } else {
                if (leftArm) leftArm.style.transform = 'rotate(-60deg)';
                if (mouth) mouth.style.height = '8px';
                if (speechBubble) {
                    const reactions = ["New message! 👀", "Someone's talking! 💬", "Interesting! 🤔"];
                    speechBubble.textContent = reactions[Math.floor(Math.random() * reactions.length)];
                    speechBubble.classList.add('show');
                }
                setTimeout(() => {
                    if (leftArm) leftArm.style.transform = 'rotate(-25deg)';
                    if (mouth) mouth.style.height = '6px';
                    setTimeout(() => { if (speechBubble) speechBubble.classList.remove('show'); }, 2000);
                }, 1000);
            }
        }

        function setUsername() {
            if (!isGameStarted) {
                alert("⏰ Please wait for the game to start before joining the chat.");
                return;
            }
            
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput?.value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            myUsername = username;
            document.getElementById('usernameOverlay').style.display = 'none';
            
            showChatGuide();
            initializeChat();
            
            // Removed audio initialization
            addSystemMessage('Welcome to the chat! Start typing messages.');
        }

        // CHAT FUNCTIONS
        function initializeChat() {
            console.log('💬 Initializing chat...');
            socket = io();
            
            socket.on('connect', function() {
                console.log('✅ Connected to server');
                socket.emit('join_chat', { username: myUsername });
            });

            socket.on('user_joined', function(data) {
                addSystemMessage(`🎉 ${data.username} joined the chat!`);
                updateOnlineCount(data.count || 1);
            });

            socket.on('user_left', function(data) {
                addSystemMessage(`👋 ${data.username} left the chat`);
                updateOnlineCount(data.count || 0);
            });

            socket.on('user_count_update', function(data) {
                updateOnlineCount(data.count);
            });

            socket.on('chat_history', function(history) {
                const chatWindow = document.getElementById('chatWindow');
                if (chatWindow && Array.isArray(history)) {
                    chatWindow.innerHTML = '';
                    history.forEach(msg => {
                        const isSent = msg.from === myUsername;
                        addMessage(msg, isSent);
                    });
                    setTimeout(() => chatWindow.scrollTop = chatWindow.scrollHeight, 100);
                }
            });

            socket.on('new_message', function(data) {
                if (data && data.from && data.text) {
                    const isSent = data.from === myUsername;
                    addMessage(data, isSent);
                    if (!isSent) characterReactToMessage(false);
                    setTimeout(() => {
                        const chatWindow = document.getElementById('chatWindow');
                        if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
                    }, 100);
                }
            });

            socket.on('winner_announced', function(data) {
                if (data && data.winners) {
                    const winners = Array.isArray(data.winners) ? data.winners.join(", ") : data.winners;
                    showWinnerAnnouncement(winners);
                    addSystemMessage(`🏆 WINNER: ${winners}! 🎉`);
                }
            });

            socket.on('timer_update', function(data) {
                console.log('📡 Timer update in chat:', data);
                if (data.is_running && data.remaining_seconds > 0) {
                    gameTimeRemaining = data.remaining_seconds;
                    if (!isGameStarted) {
                        showTimerBlock();
                        startGameTimerCountdown();
                    }
                } else {
                    isGameStarted = true;
                    hideTimerBlock();
                }
            });

            socket.on('game_started', function(data) {
                console.log('🎮 Game started - unblocking chat');
                isGameStarted = true;
                hideTimerBlock();
            });

            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            if (chatInput) chatInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            if (chatInput) chatInput.focus();
            addSystemMessage(`Welcome, ${myUsername}! Start chatting.`);
        }

        function updateOnlineCount(count) {
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) onlineCountElement.textContent = count + ' online';
        }

        function sendMessage() {
            const messageInput = document.getElementById('chatInput');
            const text = messageInput?.value.trim();
            if (!text || !socket) return;
            
            socket.emit('message', { 
                text: text,
                timestamp: new Date().toISOString()
            });
            characterReactToMessage(true);
            messageInput.value = '';
            messageInput.focus();
            setTimeout(() => {
                const chatWindow = document.getElementById('chatWindow');
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 100);
        }

        function addMessage(msg, isSent) {
            const chatWindow = document.getElementById('chatWindow');
            if (!chatWindow) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            const time = new Date(msg.timestamp || Date.now()).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            const isSelected = selectedWinners.includes(msg.from);

            messageDiv.innerHTML = `
                ${!isSent ? `<div class="sender-name ${isSelected ? 'username-selected' : ''}" data-username="${msg.from}">${msg.from}</div>` : ''}
                <div class="message-content">${msg.text}</div>
                <div class="message-time">${time}</div>
            `;

            if (!isSent) {
                const senderName = messageDiv.querySelector('.sender-name');
                if (senderName) {
                    senderName.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        toggleWinnerSelection(username);
                        this.classList.toggle('username-selected');
                        updateBellNotification();
                        if (selectedWinners.includes(username)) {
                            showSelectionFeedback(`${username} selected as winner!`);
                        } else {
                            showSelectionFeedback(`${username} removed from selection`);
                        }
                    });
                    senderName.style.cursor = 'pointer';
                    senderName.title = 'Click to select as winner';
                }
            }
            chatWindow.appendChild(messageDiv);
        }

        function addSystemMessage(text) {
            const chatWindow = document.getElementById('chatWindow');
            if (!chatWindow) return;
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-msg';
            systemMsg.textContent = text;
            chatWindow.appendChild(systemMsg);
        }

        function showSelectionFeedback(message) {
            const feedback = document.createElement('div');
            feedback.className = 'system-msg';
            feedback.textContent = message;
            feedback.style.background = 'rgba(255, 215, 0, 0.2)';
            feedback.style.color = '#333';
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.appendChild(feedback);
            setTimeout(() => { if (feedback.parentNode) feedback.remove(); }, 2000);
        }

        // BELL NOTIFICATION FUNCTIONS
        function updateBellNotification() {
            const bellNotification = document.getElementById('bellNotification');
            if (bellNotification) {
                if (selectedWinners.length > 0) {
                    bellNotification.style.display = 'flex';
                    bellNotification.textContent = selectedWinners.length;
                } else {
                    bellNotification.style.display = 'none';
                }
            }
        }

        // FIXED WINNER SELECTION PANEL FUNCTION
        function showWinnerSelectionPanel() {
            if (selectedWinners.length > 0) {
                const entered = prompt("Enter passcode to announce winners:");
                if (entered !== ANNOUNCE_PASSCODE) {
                    alert("❌ Wrong passcode!");
                    return;
                }
                showWinnerAnnouncement(selectedWinners.join(', '));
                if (socket) socket.emit('announce_winner', { winners: selectedWinners });
                selectedWinners.forEach(username => updateChatUsernameSelection(username, false));
                selectedWinners = [];
                updateSelectedCount();
                updateBellNotification();
                showSelectionFeedback('Winners announced successfully!');
                return;
            }

            // Only show panel if no winners selected
            const panel = document.getElementById('winnerSelectionPanel');
            const winnerList = document.getElementById('winnerList');
            if (!panel || !winnerList) return;
            
            winnerList.innerHTML = '';
            const allUsernames = new Set();
            const senderNames = document.querySelectorAll('.sender-name');
            senderNames.forEach(sender => {
                const username = sender.getAttribute('data-username');
                if (username && username !== myUsername) allUsernames.add(username);
            });
            
            Object.keys(onlineUsers).forEach(user => {
                if (user !== myUsername) allUsernames.add(user);
            });
            
            allUsernames.forEach(user => {
                const winnerItem = document.createElement('div');
                winnerItem.className = `winner-item ${selectedWinners.includes(user) ? 'selected' : ''}`;
                winnerItem.innerHTML = `
                    <input type="checkbox" class="winner-checkbox" ${selectedWinners.includes(user) ? 'checked' : ''} value="${user}">
                    <span>${user}</span>
                `;
                winnerItem.addEventListener('click', function() {
                    const checkbox = this.querySelector('.winner-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleWinnerSelection(user, checkbox.checked);
                    updateChatUsernameSelection(user, checkbox.checked);
                    updateBellNotification();
                });
                winnerList.appendChild(winnerItem);
            });
            
            updateSelectedCount();
            panel.style.display = 'block';
        }

        function closeWinnerPanel() {
            const panel = document.getElementById('winnerSelectionPanel');
            if (panel) panel.style.display = 'none';
        }

        function toggleWinnerSelection(username, isSelected) {
            if (isSelected === undefined) {
                if (selectedWinners.includes(username)) {
                    selectedWinners = selectedWinners.filter(user => user !== username);
                } else {
                    selectedWinners.push(username);
                }
            } else {
                if (isSelected) {
                    if (!selectedWinners.includes(username)) selectedWinners.push(username);
                } else {
                    selectedWinners = selectedWinners.filter(user => user !== username);
                }
            }
            updateSelectedCount();
            updateBellNotification();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) countElement.textContent = selectedWinners.length;
        }

        function updateChatUsernameSelection(username, isSelected) {
            const senderNames = document.querySelectorAll(`.sender-name[data-username="${username}"]`);
            senderNames.forEach(senderName => {
                if (isSelected) senderName.classList.add('username-selected');
                else senderName.classList.remove('username-selected');
            });
        }

        function announceSelectedWinners() {
            if (selectedWinners.length === 0) {
                alert("Please select winners first!");
                return;
            }
            const entered = prompt("Enter passcode to announce winners:");
            if (entered !== ANNOUNCE_PASSCODE) {
                alert("❌ Wrong passcode!");
                return;
            }
            showWinnerAnnouncement(selectedWinners.join(', '));
            if (socket) socket.emit('announce_winner', { winners: selectedWinners });
            selectedWinners.forEach(username => updateChatUsernameSelection(username, false));
            selectedWinners = [];
            updateSelectedCount();
            updateBellNotification();
            closeWinnerPanel();
            showSelectionFeedback('Winners announced successfully!');
        }

        function showWinnerAnnouncement(usernames) {
            const overlay = document.getElementById('winnerAnnouncementOverlay');
            const winnerNameElement = document.getElementById('announcedWinnerName');
            if (overlay && winnerNameElement) {
                winnerNameElement.textContent = usernames;
                overlay.style.display = 'flex';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    setTimeout(() => startCharacterDance(), 500);
                }, 10000);
            }
        }

        // KEEP ONLY ONE startCharacterDance FUNCTION
        function startCharacterDance() {
            const character = document.getElementById('animatedCharacter');
            const speechBubble = document.getElementById('speechBubble');
            if (!character) return;
            character.classList.add('dancing');
            if (speechBubble) {
                speechBubble.textContent = "🎉 CONGRATULATIONS! 🎉";
                speechBubble.classList.add('show');
            }
            setTimeout(() => stopCharacterDance(), 8000);
        }

        function stopCharacterDance() {
            const character = document.getElementById('animatedCharacter');
            if (!character) return;
            character.classList.remove('dancing');
        }

        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            if (modal) modal.style.display = 'none';
        }

        // TYPING DETECTION
        function setupTypingDetection() {
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('focus', startTyping);
            chatInput.addEventListener('input', function() {
                startTyping();
                resetTypingTimeout();
            });
            chatInput.addEventListener('blur', stopTyping);
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) sendBtn.addEventListener('click', stopTyping);
        }

        function startTyping() {
            if (!isUserTyping) {
                isUserTyping = true;
                startWalkingAnimation();
            }
            resetTypingTimeout();
        }

        function stopTyping() {
            isUserTyping = false;
            clearTimeout(typingTimeout);
            stopWalkingAnimation();
        }

        function resetTypingTimeout() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => stopTyping(), 1500);
        }

        // WALKING ANIMATION
        function startWalkingAnimation() {
            const character = document.getElementById('animatedCharacter');
            if (!character) return;
            if (characterState !== 'chat') return;
            
            character.classList.add('walking');
            
            if (walkingAnimationInterval) clearInterval(walkingAnimationInterval);
            
            const chatContainer = document.getElementById('chatContainer');
            const chatRect = chatContainer.getBoundingClientRect();
            const minX = 30;
            const maxX = chatRect.width - 150;
            let walkingDirection = 1;
            let currentX = (maxX - minX) / 2;
            
            walkingAnimationInterval = setInterval(function() {
                if (!isUserTyping) {
                    clearInterval(walkingAnimationInterval);
                    return;
                }
                
                currentX += walkingDirection * 2.5;
                if (currentX >= maxX) {
                    walkingDirection = -1;
                    setTimeout(() => {
                        character.style.transform = `translateX(${currentX}px) scale(-0.7, 0.7)`;
                    }, 200);
                } else if (currentX <= minX) {
                    walkingDirection = 1;
                    setTimeout(() => {
                        character.style.transform = `translateX(${currentX}px) scale(0.7)`;
                    }, 200);
                } else {
                    const currentScale = walkingDirection === 1 ? 'scale(0.7)' : 'scale(-0.7, 0.7)';
                    character.style.transform = `translateX(${currentX}px) ${currentScale}`;
                }
                
                const walkCycle = Date.now() / 300;
                const bobOffset = Math.sin(walkCycle) * 4;
                const walkTilt = Math.sin(walkCycle * 2) * 1;
                character.style.bottom = `calc(90px + ${bobOffset}px)`;
                character.style.transform += ` rotate(${walkTilt}deg)`;
            }, 50);
        }

        function stopWalkingAnimation() {
            const character = document.getElementById('animatedCharacter');
            if (!character) return;
            
            character.classList.remove('walking');
            if (walkingAnimationInterval) {
                clearInterval(walkingAnimationInterval);
                walkingAnimationInterval = null;
            }
            
            const currentTransform = character.style.transform || '';
            const currentTranslateX = parseFloat(currentTransform.match(/translateX\(([^)]+)px\)/)?.[1]) || 0;
            const chatContainer = document.getElementById('chatContainer');
            const chatRect = chatContainer.getBoundingClientRect();
            const centerX = (chatRect.width - 120) / 2;
            
            let startTime = Date.now();
            const duration = 800;
            const startX = currentTranslateX;
            
            function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
            
            function returnToCenter() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                const newX = startX + (centerX - startX) * easedProgress;
                character.style.transform = `translateX(${newX}px) scale(0.7) rotate(0deg)`;
                character.style.bottom = '90px';
                if (progress < 1) requestAnimationFrame(returnToCenter);
                else {
                    character.style.transform = `translateX(${centerX}px) scale(0.7) rotate(0deg)`;
                    character.style.bottom = '90px';
                }
            }
            requestAnimationFrame(returnToCenter);
        }

        // EVENT LISTENERS
        window.addEventListener('beforeunload', function() {
            if (socket && myUsername) socket.emit('leave_chat', { username: myUsername });
        });

        window.addEventListener('DOMContentLoaded', initApp);

        window.addEventListener('resize', function() {
            const character = document.getElementById('animatedCharacter');
            if (character && characterState === 'chat') {
                const isMobile = window.innerWidth <= 768;
                const bottomPosition = isMobile ? '85px' : '90px';
                const scale = isMobile ? '0.6' : '0.7';
                character.style.bottom = bottomPosition;
                character.style.left = '50%';
                character.style.transform = `translateX(-50%) scale(${scale})`;
            }
        });
    </script>
</body>
</html>