<!DOCTYPE html>
<html>
<head>
    <title>Chylnx Hub Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            height: 100vh;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: #25D366;
            color: white;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(50px, 12vw, 60px);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 15px);
        }

        .header-info h2 {
            font-size: clamp(16px, 4vw, 20px);
        }

        .header-actions {
            display: flex;
            gap: clamp(15px, 3vw, 20px);
            font-size: clamp(16px, 4vw, 18px);
        }

        #chatContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path fill="%23007bff" d="M30,30 Q50,10 70,30 Q90,50 70,70 Q50,90 30,70 Q10,50 30,30 Z"/></svg>');
            background-color: #e5ddd5;
            margin-top: clamp(50px, 12vw, 60px);
            margin-bottom: clamp(60px, 15vw, 70px);
            height: calc(100vh - clamp(50px, 12vw, 60px) - clamp(60px, 15vw, 70px));
            position: relative;
            z-index: 1;
            padding-left: 10px;
            padding-right: 10px;
        }

        #chatWindow {
            flex: 1;
            padding: clamp(15px, 3vw, 20px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 2vw, 8px);
            height: 100%;
            position: relative;
            z-index: 10;
            margin-left: 0;
            margin-right: 0;
        }

        .message {
            max-width: min(65%, 380px);
            padding: clamp(6px, 2vw, 8px) clamp(10px, 2vw, 12px);
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            z-index: 20;
            background: inherit;
            margin-left: 5px;
            margin-right: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: #dcf8c6;
            border-top-right-radius: 0;
            margin-right: 10px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
            margin-left: 10px;
        }

        .message-content {
            margin-bottom: 2px;
            line-height: 1.4;
            font-size: clamp(14px, 3vw, 16px);
            word-break: break-word;
            padding: 2px 0;
        }

        .message-time {
            font-size: clamp(10px, 2vw, 11px);
            color: #667781;
            text-align: right;
            margin-top: 2px;
        }

        .message.received .message-time {
            text-align: left;
        }

        .sender-name {
            font-weight: 600;
            color: #25D366;
            font-size: clamp(11px, 2.5vw, 13px);
            margin-bottom: 2px;
            cursor: pointer;
            position: relative;
            z-index: 25;
            transition: all 0.3s ease;
        }

        .sender-name:hover {
            text-decoration: underline;
        }

        .selected-sender .sender-name {
            background: rgba(37, 211, 102, 0.2);
            padding: 2px 6px;
            border-radius: 12px;
        }

        #inputArea {
            background: #f0f0f0;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            border-top: 1px solid #d1d7db;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(60px, 15vw, 70px);
            z-index: 1000;
        }

        #chatInput {
            flex: 1;
            padding: clamp(10px, 2vw, 12px) clamp(12px, 3vw, 16px);
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: clamp(14px, 3vw, 15px);
            background: white;
            min-width: 0;
        }

        #sendBtn {
            background: #25D366;
            border: none;
            border-radius: 50%;
            width: clamp(35px, 10vw, 40px);
            height: clamp(35px, 10vw, 40px);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: clamp(14px, 3vw, 16px);
            flex-shrink: 0;
        }

        #sendBtn:hover {
            background: #20bd5a;
        }

        #sendBtn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }

        .system-msg {
            text-align: center;
            color: #667781;
            font-size: clamp(12px, 2.5vw, 13px);
            margin: clamp(8px, 2vw, 10px) 20px;
            font-style: italic;
            padding: 0 10px;
        }

        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            text-align: center;
            padding: clamp(10px, 2vw, 12px);
            font-weight: bold;
            margin: clamp(8px, 2vw, 10px) 20px;
            border-radius: 8px;
            animation: winnerPulse 2s infinite;
            font-size: clamp(14px, 3vw, 16px);
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        #usernameOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667781 0%, #25D366 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #usernameForm {
            background: white;
            padding: clamp(25px, 6vw, 40px);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: min(400px, 95vw);
            margin: 20px;
        }

        #usernameForm h3 {
            margin-bottom: clamp(15px, 3vw, 20px);
            color: #333;
            font-size: clamp(18px, 4vw, 22px);
        }

        #usernameForm input {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: clamp(15px, 3vw, 20px);
            outline: none;
            transition: border-color 0.3s;
        }

        #usernameForm input:focus {
            border-color: #25D366;
        }

        #usernameForm button {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            cursor: pointer;
            transition: background 0.3s;
        }

        #usernameForm button:hover {
            background: #20bd5a;
        }

        .form-note {
            margin-top: clamp(15px, 3vw, 20px);
            color: #666;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }

        #chatWindow::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatWindow::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 3px;
        }

        #winnerModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .winner-modal-content {
            background: white;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 15px;
            text-align: center;
            max-width: min(400px, 90vw);
            margin: 20px;
        }

        .winner-modal-content h2 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 15px;
        }

        .winner-modal-content p {
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 20px;
        }

        .winner-modal-content button {
            padding: clamp(8px, 2vw, 10px) clamp(15px, 3vw, 20px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
        }

        #winnerAnnouncementOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            animation: fadeIn 0.5s ease-in;
        }

        .winner-announcement-content {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            padding: clamp(30px, 6vw, 50px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5);
            max-width: min(500px, 90vw);
            width: 100%;
            animation: scaleUp 0.5s ease-out, glow 2s infinite alternate;
            border: 3px solid #fff;
        }

        @keyframes scaleUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes glow {
            from { box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 10px 70px rgba(255, 215, 0, 0.8); }
        }

        .winner-announcement-content h2 {
            font-size: clamp(24px, 6vw, 36px);
            color: #000;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .winner-announcement-content p {
            font-size: clamp(20px, 5vw, 28px);
            color: #000;
            font-weight: bold;
            margin: 20px 0;
        }

        .winner-announcement-content .winner-trophy {
            font-size: clamp(40px, 10vw, 60px);
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .winner-selection-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .winner-panel-header {
            background: #25D366;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .winner-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .winner-list {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .winner-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .winner-item:hover {
            background: #f5f5f5;
        }

        .winner-item.selected {
            background: #e3f2fd;
        }

        .winner-checkbox {
            margin-right: 10px;
        }

        .winner-actions {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .winner-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #confirmWinners {
            background: #25D366;
            color: white;
        }

        #cancelWinners {
            background: #f0f0f0;
            color: #333;
        }

        .selected-count {
            background: #ffd700;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .username-selected {
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #000 !important;
            font-weight: bold !important;
            padding: 3px 8px !important;
            border-radius: 15px !important;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5) !important;
            border: 2px solid #ff8c00 !important;
            animation: pulseGlow 2s infinite !important;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 2px 15px rgba(255, 215, 0, 0.8); }
        }

        #usernameForm .timer-display {
            font-size: 2rem;
            color: #25D366;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(37, 211, 102, 0.5);
        }

        #usernameForm .waiting-message {
            color: #666;
            margin: 15px 0;
            line-height: 1.4;
        }

        #usernameForm .refresh-btn {
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        #usernameForm .refresh-btn:hover {
            background: #20bd5a;
        }

        #bell {
            font-size: 2rem;
            cursor: pointer;
            display: inline-block;
            animation: gentleSwing 4s ease-in-out infinite;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        #bell:hover {
            animation: excitedRing 0.4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px gold);
        }

        @keyframes gentleSwing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }

        @keyframes excitedRing {
            0%, 100% { transform: rotate(0deg) scale(1.2); }
            25% { transform: rotate(-12deg) scale(1.2); }
            75% { transform: rotate(12deg) scale(1.2); }
        }

        .animated-character {
            position: fixed;
            z-index: 5;
            transition: all 1s ease-in-out;
            pointer-events: none;
            display: block !important;
            visibility: visible !important;
        }

        .character-body {
            position: relative;
            width: 120px;
            height: 160px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        .character-head {
            width: 80px;
            height: 75px;
            background: linear-gradient(135deg, #ffdbac 0%, #f1c27d 100%);
            border-radius: 45% 45% 50% 50%;
            margin: 0 auto 5px;
            position: relative;
            border: 2px solid #e0a96d;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .character-cap {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 25px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            border-radius: 50% 50% 0 0;
            z-index: 2;
        }

        .cap-bill {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 8px;
            background: #1e3a8a;
            border-radius: 4px;
        }

        .character-face {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 50%;
        }

        .character-eyes {
            position: absolute;
            top: 5px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 8px;
            transition: transform 0.3s ease;
            z-index: 3;
        }

        .eye {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            position: relative;
            border: 2px solid #333;
            animation: blink 4s infinite;
            overflow: hidden;
        }

        .eye::after {
            content: '';
            position: absolute;
            width: 7px;
            height: 7px;
            background: #333;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.2s ease;
        }

        .character-glasses {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 20px;
            z-index: 4;
        }

        .glasses-frame {
            position: absolute;
            width: 45px;
            height: 18px;
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .glasses-bridge {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 2px;
            background: #333;
        }

        .character-mouth {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 6px;
            background: #e75480;
            border-radius: 0 0 8px 8px;
            transition: all 0.3s ease;
        }

        .character-body-main {
            width: 65px;
            height: 55px;
            background: linear-gradient(135deg, #4a86e8 0%, #3a76d8 100%);
            border-radius: 20px 20px 15px 15px;
            margin: 0 auto;
            border: 2px solid #2c5aa0;
            position: relative;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2);
        }

        .shirt-collar {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 8px;
            background: #4a86e8;
            border-radius: 4px 4px 0 0;
        }

        .character-tie {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 25px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 0 0 4px 4px;
        }

        .tie-knot {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 8px;
            background: #c0392b;
            border-radius: 50%;
        }

        .character-arm {
            position: absolute;
            width: 16px;
            background: linear-gradient(135deg, #4a86e8 0%, #3a76d8 100%);
            border: 2px solid #2c5aa0;
            border-radius: 10px;
            transition: all 0.5s ease;
            transform-origin: top center;
            box-shadow: inset -1px -1px 2px rgba(0,0,0,0.1);
        }

        .left-arm {
            height: 45px;
            top: 40px;
            left: -6px;
            transform: rotate(-25deg);
        }

        .right-arm {
            height: 45px;
            top: 40px;
            right: -6px;
            transform: rotate(25deg);
        }

        .character-leg {
            position: absolute;
            width: 18px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 2px solid #2c3e50;
            border-radius: 6px 6px 10px 10px;
            bottom: -35px;
            transform-origin: top center;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .left-leg {
            height: 35px;
            left: 16px;
        }

        .right-leg {
            height: 35px;
            right: 16px;
        }

        .speech-bubble {
            position: absolute;
            background: white;
            padding: 12px 18px;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: #333;
            max-width: 200px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            pointer-events: none;
            border: 2px solid #25D366;
            z-index: 10001;
            word-wrap: break-word;
            left: 50% !important;
            transform: translateX(-50%) !important;
        }

        .animated-character.username-guide .speech-bubble {
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
        }

        .animated-character.chat-guide .speech-bubble {
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            border: 12px solid transparent;
        }

        .animated-character.username-guide .speech-bubble::after {
            border-top-color: white;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .animated-character.chat-guide .speech-bubble::after {
            border-top-color: white;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .animated-character.username-guide {
            top: 40% !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translate(-50%, -50%) scale(0.8) !important;
            z-index: 5 !important;
            pointer-events: none;
        }

        .animated-character.chat-guide {
            bottom: 100px !important;
            left: 50% !important;
            right: auto !important;
            top: auto !important;
            transform: translateX(-50%) scale(0.7) !important;
            z-index: 5 !important;
            pointer-events: none;
        }

        @keyframes gentleSway {
            0%, 100% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(-3px) rotate(-1deg); }
            75% { transform: translateX(3px) rotate(1deg); }
        }

        @keyframes breathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes excitedJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes walk {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }

        @keyframes typing {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ADD MISSING ANIMATIONS */
        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        @keyframes pointDown {
            0%, 100% { transform: rotate(90deg); }
            50% { transform: rotate(100deg); }
        }

        @keyframes nod {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        .animated-character.username-guide {
            animation: gentleSway 3s ease-in-out infinite, excitedJump 2s ease-in-out infinite;
        }

        .animated-character.username-guide .right-arm {
            animation: pointDown 2s ease-in-out infinite;
            transform: rotate(90deg);
        }

        .animated-character.chat-guide {
            animation: breathing 4s ease-in-out infinite;
        }

        .animated-character.chat-guide .character-head {
            animation: gentleSway 6s ease-in-out infinite;
        }

        .animated-character.walking {
            animation: walk 0.6s ease-in-out infinite;
        }

        .animated-character.walking .left-leg {
            animation: walk 0.6s ease-in-out infinite;
        }

        .animated-character.walking .right-leg {
            animation: walk 0.6s ease-in-out infinite reverse;
        }

        .speech-bubble.show {
            opacity: 1;
            transform: translateY(0);
            animation: typing 0.5s ease-in-out;
        }

        .character-talking .character-mouth {
            animation: talk 0.3s ease-in-out infinite;
        }

        @keyframes talk {
            0%, 100% { height: 4px; }
            50% { height: 8px; }
        }

        .character-excited {
            animation: excitedJump 0.5s ease-in-out 3 !important;
        }

        .animated-character.dancing {
            animation: danceMove 1s ease-in-out infinite !important;
        }

        .animated-character.dancing .character-head {
            animation: headBob 0.5s ease-in-out infinite !important;
        }

        .animated-character.dancing .left-arm {
            animation: armWaveLeft 0.8s ease-in-out infinite !important;
        }

        .animated-character.dancing .right-arm {
            animation: armWaveRight 0.8s ease-in-out infinite !important;
        }

        .animated-character.dancing .left-leg {
            animation: legKickLeft 0.6s ease-in-out infinite !important;
        }

        .animated-character.dancing .right-leg {
            animation: legKickRight 0.6s ease-in-out infinite !important;
        }

        .animated-character.dancing .character-body-main {
            animation: bodyBounce 0.4s ease-in-out infinite !important;
        }

        .animated-character.dancing .speech-bubble {
            content: "üéâ CONGRATULATIONS! üéâ" !important;
            animation: bubbleCelebrate 0.5s ease-in-out infinite !important;
        }

        @keyframes danceMove {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            25% { transform: translateX(-50%) translateY(-10px) rotate(-5deg); }
            50% { transform: translateX(-50%) translateY(-5px) rotate(0deg); }
            75% { transform: translateX(-50%) translateY(-10px) rotate(5deg); }
        }

        @keyframes headBob {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(10deg); }
        }

        @keyframes armWaveLeft {
            0%, 100% { transform: rotate(-20deg); }
            50% { transform: rotate(60deg); }
        }

        @keyframes armWaveRight {
            0%, 100% { transform: rotate(20deg); }
            50% { transform: rotate(-60deg); }
        }

        @keyframes legKickLeft {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(30deg); }
        }

        @keyframes legKickRight {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-30deg); }
        }

        @keyframes bodyBounce {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.95); }
        }

        @keyframes bubbleCelebrate {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        .bell-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .message {
            position: relative;
            z-index: 20 !important;
            background: inherit !important;
            margin: 4px 0;
        }

        .message.sent {
            background: #dcf8c6 !important;
        }

        .message.received {
            background: white !important;
        }

        .sender-name {
            position: relative;
            z-index: 25 !important;
        }

        @media (max-width: 480px) {
            .message {
                max-width: 80% !important;
                margin-left: 8px;
                margin-right: 8px;
            }
            
            .message.sent {
                margin-right: 15px;
            }
            
            .message.received {
                margin-left: 15px;
            }
            
            #chatWindow {
                padding: 12px 8px !important;
            }
            
            #chatContainer {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .header-info {
                gap: 8px;
            }
            
            .header-actions {
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 75% !important;
            }
            
            #chatWindow {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        @media (max-width: 320px) {
            .message {
                max-width: 70% !important;
                margin-left: 5px;
                margin-right: 5px;
            }
            
            .message.sent {
                margin-right: 8px;
            }
            
            .message.received {
                margin-left: 8px;
            }
            
            #chatWindow {
                padding: 8px 4px !important;
            }
            
            #chatContainer {
                padding-left: 2px;
                padding-right: 2px;
            }
            
            #usernameForm {
                padding: 20px 15px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .message {
                max-width: 70% !important;
            }
            
            #chatWindow {
                padding-left: 15px;
                padding-right: 15px;
            }
        }

        @media (min-width: 1025px) {
            .message {
                max-width: 60% !important;
            }
            
            #chatWindow {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            #chatContainer {
                margin-top: 60px;
                margin-bottom: 70px;
            }
            
            header {
                padding: 10px 16px;
                height: 60px;
            }
            
            #inputArea {
                padding: 10px 16px;
                height: 70px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .message {
                max-width: 60% !important;
            }
            
            #chatWindow {
                padding: 10px 5px !important;
            }
            
            #chatContainer {
                padding-left: 5px;
                padding-right: 5px;
            }
        }

        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        @media (max-height: 700px) {
            #chatContainer {
                margin-bottom: 50px !important;
            }
            
            .animated-character.chat-guide {
                bottom: 70px !important;
            }
            
            #inputArea {
                height: 50px !important;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            #chatContainer {
                margin-top: 50px !important;
                margin-bottom: 45px !important;
            }
            
            header {
                height: 45px !important;
            }
            
            #inputArea {
                height: 45px !important;
            }
            
            .animated-character {
                display: block !important;
                visibility: visible !important;
            }
            
            .animated-character.username-guide {
                top: 50% !important;
                transform: translate(-50%, -50%) scale(0.5) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 70px !important;
                transform: translateX(-50%) scale(0.45) !important;
            }
        }

        #sendBtn {
            min-width: 40px;
            min-height: 40px;
        }

        #chatInput {
            min-height: 40px;
        }

        #animatedCharacter {
            display: block !important;
            visibility: visible !important;
        }

        @media (max-width: 768px) {
            .speech-bubble {
                max-width: 180px !important;
                font-size: 13px !important;
                padding: 10px 14px !important;
            }
            
            .animated-character.username-guide {
                transform: translate(-50%, -50%) scale(0.7) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 95px !important;
                transform: translateX(-50%) scale(0.6) !important;
            }
        }

        @media (max-width: 480px) {
            .speech-bubble {
                max-width: 160px !important;
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            .animated-character.username-guide {
                transform: translate(-50%, -50%) scale(0.6) !important;
            }
            
            .animated-character.chat-guide {
                bottom: 90px !important;
                transform: translateX(-50%) scale(0.5) !important;
            }
        }
    </style>
</head>
<body data-paid="false">
    <div id="winnerSelectionPanel" class="winner-selection-panel">
        <div class="winner-panel-header">
            <h3>Select Winners <span id="selectedCount" class="selected-count">0</span></h3>
            <span onclick="closeWinnerPanel()" style="cursor: pointer; font-size: 18px;">√ó</span>
        </div>
        <div class="winner-list" id="winnerList">
        </div>
        <div class="winner-actions">
            <button id="cancelWinners" onclick="closeWinnerPanel()">Cancel</button>
            <button id="confirmWinners" onclick="announceSelectedWinners()">Announce Winners</button>
        </div>
    </div>

    <div id="usernameOverlay">
        <div id="usernameForm">
            <h3>Join the Chat</h3>
            <input type="text" id="usernameInput" placeholder="Enter your username" autocomplete="off">
            <button onclick="setUsername()">Start Chatting</button>
            <div class="form-note">
                Choose a cool name to get started!
            </div>
        </div>
    </div>

    <header>
        <div class="header-info">
            <h2>üí¨ Chylnx Chat</h2>
           <span id="onlineCount">Loading...</span>
        </div>
        <div class="header-actions">
            <span id="bellContainer" style="position: relative;">
                <span id="bell" title="Announce Winner">üîî</span>
                <span id="bellNotification" class="bell-notification" style="display: none;">0</span>
            </span>
        </div>
    </header>

    <div id="chatContainer">
        <div id="chatWindow">
            <div class="system-msg">Welcome to the chat! Type a message to begin.</div>
        </div>
    </div>

    <div id="inputArea">
        <input id="chatInput" type="text" placeholder="Type a message..." disabled>
        <button id="sendBtn" disabled>‚û§</button>
    </div>

    <div class="animated-character username-guide" id="animatedCharacter">
        <div class="character-body">
            <div class="character-head">
                <div class="character-cap">
                    <div class="cap-bill"></div>
                </div>
                <div class="character-face">
                    <div class="character-glasses">
                        <div class="glasses-frame"></div>
                        <div class="glasses-bridge"></div>
                    </div>
                    <div class="character-eyes">
                        <div class="eye left-eye"></div>
                        <div class="eye right-eye"></div>
                    </div>
                    <div class="character-mouth"></div>
                </div>
            </div>
            <div class="character-body-main">
                <div class="shirt-collar"></div>
                <div class="character-tie">
                    <div class="tie-knot"></div>
                </div>
            </div>
            <div class="character-arm left-arm"></div>
            <div class="character-arm right-arm"></div>
            <div class="character-leg left-leg"></div>
            <div class="character-leg right-leg"></div>
        </div>
        <div class="speech-bubble show" id="speechBubble">
            INPUT A COOL USERNAME! üéÆ
        </div>
    </div>

    <div id="winnerModal">
        <div class="winner-modal-content">
            <h2>üéâ Winner Selected! üéâ</h2>
            <p id="winnerMessage">THE WINNER IS: <span id="winnerName"></span></p>
            <button onclick="closeWinnerModal()">Close</button>
        </div>
    </div>

    <div id="winnerAnnouncementOverlay">
        <div class="winner-announcement-content">
            <div class="winner-trophy">üèÜ</div>
            <h2>WINNER ANNOUNCED!</h2>
            <p>CONGRATULATIONS TO:</p>
            <p id="announcedWinnerName" style="font-size: clamp(24px, 6vw, 32px); color: #000; font-weight: bold;"></p>
            <p style="margin-top: 20px; font-size: clamp(14px, 3vw, 18px);">This announcement will close automatically</p>
        </div>
    </div>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    let myUsername = "";
    let socket = null;
    let selectedWinners = [];
    let onlineUsers = [];
    let isGameStarted = false;
    let characterState = 'username';
    const ANNOUNCE_PASSCODE = "1234";
    let messageInterval;

    function initApp() {
        console.log('üöÄ Initializing app...');
        
        const sendBtn = document.getElementById('sendBtn');
        const chatInput = document.getElementById('chatInput');
        const bell = document.getElementById('bell');
        const usernameInput = document.getElementById('usernameInput');
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        if (bell) bell.addEventListener('click', showWinnerSelectionPanel);
        if (usernameInput) usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') setUsername();
        });

        const usernameOverlay = document.getElementById('usernameOverlay');
        if (usernameOverlay) usernameOverlay.style.display = 'flex';
        
        initializeCharacter();
        
        setupMobileKeyboard();
        
        if (usernameInput) usernameInput.focus();
        
        console.log('‚úÖ App initialized successfully');
    }

    function initializeCharacter() {
        const character = document.getElementById('animatedCharacter');
        if (!character) {
            console.log('‚ö†Ô∏è Character element not found');
            return;
        }
        
        character.style.display = 'block';
        character.style.visibility = 'visible';
        
        showUsernameGuide();
        
        startRepeatingMessages();
    }

    function startRepeatingMessages() {
        const messages = [
            "INPUT A COOL USERNAME! üéÆ",
            "CHOOSE AN AWESOME NAME! ‚ú®", 
            "PICK A CREATIVE USERNAME! üöÄ",
            "ENTER YOUR COOL NAME! üí´"
        ];
        
        let messageIndex = 0;
        const speechBubble = document.getElementById('speechBubble');
        
        if (messageInterval) clearInterval(messageInterval);
        
        messageInterval = setInterval(() => {
            if (speechBubble && characterState === 'username') {
                speechBubble.textContent = messages[messageIndex];
                speechBubble.classList.add('show');
                
                speechBubble.style.animation = 'typing 0.5s ease-in-out';
                
                messageIndex = (messageIndex + 1) % messages.length;
            }
        }, 3000);
    }

    function showUsernameGuide() {
        const character = document.getElementById('animatedCharacter');
        const speechBubble = document.getElementById('speechBubble');
        
        if (!character) return;
        
        characterState = 'username';
        character.className = 'animated-character username-guide';
        character.style.display = 'block';
        character.style.visibility = 'visible';
        
        character.style.top = '40%';
        character.style.left = '50%';
        character.style.right = 'auto';
        character.style.bottom = 'auto';
        character.style.transform = 'translate(-50%, -50%) scale(0.8)';
        
        if (speechBubble) {
            speechBubble.textContent = 'INPUT A COOL USERNAME! üéÆ';
            speechBubble.classList.remove('show');
            setTimeout(() => speechBubble.classList.add('show'), 500);
        }
    }

    function showChatGuide() {
        const character = document.getElementById('animatedCharacter');
        const speechBubble = document.getElementById('speechBubble');
        
        if (!character) return;
        
        if (messageInterval) clearInterval(messageInterval);
        
        character.classList.add('walking');
        character.style.transition = 'all 2s ease-in-out';
        
        const isMobile = window.innerWidth <= 768;
        const bottomPosition = isMobile ? '85px' : '90px';
        const scale = isMobile ? '0.6' : '0.7';
        
        character.style.bottom = bottomPosition;
        character.style.left = '50%';
        character.style.right = 'auto';
        character.style.top = 'auto';
        character.style.transform = `translateX(-50%) scale(${scale})`;
        character.style.zIndex = '5';
        
        setTimeout(() => {
            character.classList.remove('walking');
            characterState = 'chat';
            character.className = 'animated-character chat-guide';
            
            if (speechBubble) {
                speechBubble.textContent = 'Welcome to the chat! Start typing.';
                speechBubble.classList.remove('show');
                setTimeout(() => speechBubble.classList.add('show'), 1000);
                
                setTimeout(() => {
                    speechBubble.classList.remove('show');
                }, 5000);
            }
            
            initializeChatCharacter();
        }, 2000);
    }

    function initializeChatCharacter() {
        const chatContainer = document.getElementById('chatContainer');
        const character = document.getElementById('animatedCharacter');
        
        if (!chatContainer || !character) return;
        
        setupMessageFollowing();
    }

    function setupMessageFollowing() {
        const chatWindow = document.getElementById('chatWindow');
        const character = document.getElementById('animatedCharacter');
        
        if (!chatWindow || !character) return;
        
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.classList && (node.classList.contains('message') || node.classList.contains('system-msg'))) {
                            followMessage(node);
                        }
                    });
                }
            });
        });
        
        observer.observe(chatWindow, { childList: true });
    }

    function followMessage(messageElement) {
        const character = document.getElementById('animatedCharacter');
        const eyes = character?.querySelector('.character-eyes');
        
        if (!character || !eyes) return;
        
        const messageRect = messageElement.getBoundingClientRect();
        const characterRect = character.getBoundingClientRect();
        
        const messageCenterX = messageRect.left + messageRect.width / 2;
        const characterCenterX = characterRect.left + characterRect.width / 2;
        
        const deltaX = messageCenterX - characterCenterX;
        
        const eyeMovement = Math.min(Math.max(deltaX / 50, -15), 15);
        eyes.style.transform = `translateX(${eyeMovement}px)`;
        
        characterReactToMessage(messageElement.classList.contains('sent'));
    }

    function characterReactToMessage(isMyMessage) {
        if (characterState !== 'chat') return;
        
        const character = document.getElementById('animatedCharacter');
        const rightArm = character?.querySelector('.right-arm');
        const leftArm = character?.querySelector('.left-arm');
        const speechBubble = document.getElementById('speechBubble');
        
        if (!character || !rightArm) return;
        
        if (isMyMessage) {
            rightArm.style.transform = 'rotate(120deg)';
            if (speechBubble) {
                speechBubble.textContent = 'Message sent! üì§';
                speechBubble.classList.add('show');
            }
            setTimeout(() => {
                rightArm.style.transform = 'rotate(-45deg)';
                setTimeout(() => {
                    if (speechBubble) speechBubble.classList.remove('show');
                }, 2000);
            }, 1000);
        } else {
            character.style.animation = 'nod 1s ease-in-out';
            leftArm.style.transform = 'rotate(45deg)';
            if (speechBubble) {
                speechBubble.textContent = 'New message! üëÄ';
                speechBubble.classList.add('show');
            }
            setTimeout(() => {
                character.style.animation = 'breathing 4s ease-in-out infinite';
                leftArm.style.transform = 'rotate(-45deg)';
                setTimeout(() => {
                    if (speechBubble) speechBubble.classList.remove('show');
                }, 2000);
            }, 1000);
        }
    }

    function startCharacterDance() {
        const character = document.getElementById('animatedCharacter');
        const speechBubble = document.getElementById('speechBubble');
        
        if (!character) return;
        
        console.log('üíÉ Starting character dance!');
        
        character.classList.add('dancing');
        
        if (speechBubble) {
            speechBubble.textContent = "üéâ CONGRATULATIONS! üéâ";
            speechBubble.classList.add('show');
        }
        
        setTimeout(() => {
            stopCharacterDance();
        }, 8000);
    }

    function stopCharacterDance() {
        const character = document.getElementById('animatedCharacter');
        const speechBubble = document.getElementById('speechBubble');
        
        if (!character) return;
        
        console.log('üíÉ Stopping character dance');
        
        character.classList.remove('dancing');
        
        character.style.animation = 'breathing 4s ease-in-out infinite';
        
        if (speechBubble) {
            setTimeout(() => {
                speechBubble.classList.remove('show');
            }, 2000);
        }
    }

    function setupMobileKeyboard() {
        const chatInput = document.getElementById('chatInput');
        
        if (!chatInput) return;
        
        chatInput.addEventListener('focus', function() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('keyboard-open');
                
                setTimeout(() => {
                    const chatWindow = document.getElementById('chatWindow');
                    if (chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }, 300);
            }
        });
        
        chatInput.addEventListener('blur', function() {
            document.body.classList.remove('keyboard-open');
        });
    }

    function setUsername() {
        const usernameInput = document.getElementById('usernameInput');
        const username = usernameInput?.value.trim();
        
        if (!username) {
            alert('Please enter a username');
            return;
        }
        
        myUsername = username;
        const usernameOverlay = document.getElementById('usernameOverlay');
        if (usernameOverlay) usernameOverlay.style.display = 'none';
        
        if (messageInterval) clearInterval(messageInterval);
        
        showChatGuide();
        initializeChat();
    }

    function initializeChat() {
        socket = io();
        
        socket.on('connect', function() {
            console.log('‚úÖ Connected to server');
            socket.emit('join_chat', { username: myUsername });
        });

        socket.on('user_joined', function(data) {
            addSystemMessage(`üéâ ${data.username} joined the chat!`);
            updateOnlineCount(Object.keys(data.online_users || {}).length);
        });

        socket.on('user_left', function(data) {
            // FIXED: Corrected the string quote mismatch
            addSystemMessage(`üëã ${data.username} left the chat`);
            updateOnlineCount(Object.keys(data.online_users || {}).length);
        });

        socket.on('user_count_update', function(data) {
            updateOnlineCount(data.count);
        });

        socket.on('chat_history', function(history) {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow) {
                chatWindow.innerHTML = '';
                history.forEach(msg => {
                    const isSent = msg.from === myUsername;
                    addMessage(msg, isSent);
                });
            }
        });

        socket.on('new_message', function(data) {
            const isSent = data.from === myUsername;
            addMessage(data, isSent);
            if (!isSent) characterReactToMessage(false);
        });

        socket.on('winner_announced', function(data) {
            const winners = Array.isArray(data.winners) ? data.winners.join(", ") : data.winners;
            showWinnerAnnouncement(winners);
            addSystemMessage(`üèÜ WINNER: ${winners}! üéâ`);
        });

        socket.on('message_error', function(data) {
            console.error('‚ùå Message error:', data.error);
            alert('Message error: ' + data.error);
        });

        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        
        if (chatInput) chatInput.disabled = false;
        if (sendBtn) sendBtn.disabled = false;
        
        if (chatInput) chatInput.focus();
        
        addSystemMessage(`Welcome, ${myUsername}! Start chatting.`);
    }

    function updateOnlineCount(count) {
        const onlineCountElement = document.getElementById('onlineCount');
        if (onlineCountElement) {
            onlineCountElement.textContent = count + ' online';
            console.log('üë• Online users updated:', count);
        }
    }

    function sendMessage() {
        const messageInput = document.getElementById('chatInput');
        const text = messageInput?.value.trim();
        
        if (!text || !socket) return;
        
        socket.emit('message', { 
            text: text
        });
        
        messageInput.value = '';
        messageInput.focus();
        
        characterReactToMessage(true);
    }

    function addMessage(msg, isSent) {
        const chatWindow = document.getElementById('chatWindow');
        if (!chatWindow) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

        const time = new Date(msg.timestamp).toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        const isSelected = selectedWinners.includes(msg.from);

        messageDiv.innerHTML = `
            ${!isSent ? `<div class="sender-name ${isSelected ? 'username-selected' : ''}" data-username="${msg.from}">${msg.from}</div>` : ''}
            <div class="message-content">${msg.text}</div>
            <div class="message-time">${time}</div>
        `;

        if (!isSent) {
            const senderName = messageDiv.querySelector('.sender-name');
            senderName.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                toggleWinnerSelection(username);
                
                this.classList.toggle('username-selected');
                
                updateBellNotification();
                
                if (selectedWinners.includes(username)) {
                    showSelectionFeedback(`${username} selected as winner!`);
                } else {
                    showSelectionFeedback(`${username} removed from selection`);
                }
            });
            
            senderName.style.cursor = 'pointer';
            senderName.title = 'Click to select as winner';
        }

        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function addSystemMessage(text) {
        const chatWindow = document.getElementById('chatWindow');
        if (!chatWindow) return;

        const systemMsg = document.createElement('div');
        systemMsg.className = 'system-msg';
        systemMsg.textContent = text;

        chatWindow.appendChild(systemMsg);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showSelectionFeedback(message) {
        const feedback = document.createElement('div');
        feedback.className = 'system-msg';
        feedback.textContent = message;
        feedback.style.background = 'rgba(255, 215, 0, 0.2)';
        feedback.style.color = '#333';
        
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.appendChild(feedback);
        
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.remove();
            }
        }, 2000);
    }

    function updateBellNotification() {
        const bellNotification = document.getElementById('bellNotification');
        if (bellNotification) {
            if (selectedWinners.length > 0) {
                bellNotification.style.display = 'flex';
                bellNotification.textContent = selectedWinners.length;
            } else {
                bellNotification.style.display = 'none';
            }
        }
    }

function showWinnerSelectionPanel() {
    const entered = prompt("Enter passcode to announce a random winner:");
    if (entered !== ANNOUNCE_PASSCODE) {
        if (entered !== null) {
            alert("‚ùå Wrong passcode!");
        }
        return;
    }

    const allUsernames = new Set();
    const senderNames = document.querySelectorAll('.sender-name');
    senderNames.forEach(sender => {
        const username = sender.getAttribute('data-username');
        if (username && username !== myUsername) {
            allUsernames.add(username);
        }
    });

    Object.keys(onlineUsers).forEach(user => {
        if (user !== myUsername) {
            allUsernames.add(user);
        }
    });

    if (allUsernames.size === 0) {
        alert("No users available to select as winner!");
        return;
    }

    const usersArray = Array.from(allUsernames);
    const randomWinner = usersArray[Math.floor(Math.random() * usersArray.length)];
    
    showWinnerAnnouncement(randomWinner);
    
    if (socket) {
        socket.emit('announce_winner', { winners: [randomWinner] });
    }
    
    showSelectionFeedback(`Random winner announced: ${randomWinner}!`);
}

    function closeWinnerPanel() {
        const panel = document.getElementById('winnerSelectionPanel');
        if (panel) panel.style.display = 'none';
    }

    function toggleWinnerSelection(username, isSelected) {
        if (isSelected) {
            if (!selectedWinners.includes(username)) {
                selectedWinners.push(username);
            }
        } else {
            selectedWinners = selectedWinners.filter(user => user !== username);
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = selectedWinners.length;
        }
    }

    function updateChatUsernameSelection(username, isSelected) {
        const senderNames = document.querySelectorAll(`.sender-name[data-username="${username}"]`);
        senderNames.forEach(senderName => {
            if (isSelected) {
                senderName.classList.add('username-selected');
            } else {
                senderName.classList.remove('username-selected');
            }
        });
    }

    function announceSelectedWinners() {
        if (selectedWinners.length === 0) {
            alert("Please select winners first!");
            return;
        }
        
        const entered = prompt("Enter passcode to announce winners:");
        if (entered !== ANNOUNCE_PASSCODE) {
            alert("‚ùå Wrong passcode!");
            return;
        }

        showWinnerAnnouncement(selectedWinners.join(', '));
        
        if (socket) {
            socket.emit('announce_winner', { winners: selectedWinners });
        }

        selectedWinners.forEach(username => {
            updateChatUsernameSelection(username, false);
        });
        selectedWinners = [];
        
        updateSelectedCount();
        updateBellNotification();
        closeWinnerPanel();
        
        showSelectionFeedback('Winners announced successfully!');
    }

    function showWinnerAnnouncement(usernames) {
        const overlay = document.getElementById('winnerAnnouncementOverlay');
        const winnerNameElement = document.getElementById('announcedWinnerName');
        
        if (overlay && winnerNameElement) {
            winnerNameElement.textContent = usernames;
            overlay.style.display = 'flex';
            
            setTimeout(() => {
                overlay.style.display = 'none';
                setTimeout(() => {
                    startCharacterDance();
                }, 500);
            }, 10000);
        }
    }

    function closeWinnerModal() {
        const modal = document.getElementById('winnerModal');
        if (modal) modal.style.display = 'none';
    }

    window.addEventListener('beforeunload', function() {
        if (socket && myUsername) {
            socket.emit('leave_chat', { username: myUsername });
        }
    });

    window.addEventListener('DOMContentLoaded', initApp);

    window.addEventListener('resize', function() {
        const character = document.getElementById('animatedCharacter');
        if (character && characterState === 'chat') {
            const isMobile = window.innerWidth <= 768;
            const bottomPosition = isMobile ? '85px' : '90px';
            const scale = isMobile ? '0.6' : '0.7';
            
            character.style.bottom = bottomPosition;
            character.style.left = '50%';
            character.style.transform = `translateX(-50%) scale(${scale})`;
        }
    });

function cleanupOldMessages() {
    const chatWindow = document.getElementById('chatWindow');
    if (!chatWindow) return;
    
    const messages = chatWindow.querySelectorAll('.message, .system-msg');
    const now = new Date().getTime();
    const twentyFourHours = 24 * 60 * 60 * 1000;
    
    messages.forEach(message => {
        const messageTimeElement = message.querySelector('.message-time');
        if (messageTimeElement) {
            const timeText = messageTimeElement.textContent;
            const messageTime = parseMessageTime(timeText);
            if (messageTime && (now - messageTime > twentyFourHours)) {
                message.remove();
            }
        }
    });
}

function parseMessageTime(timeText) {
    try {
        const now = new Date();
        const [timePart, modifier] = timeText.split(' ');
        let [hours, minutes] = timePart.split(':').map(Number);
        
        if (modifier === 'PM' && hours < 12) hours += 12;
        if (modifier === 'AM' && hours === 12) hours = 0;
        
        const messageDate = new Date(now);
        messageDate.setHours(hours, minutes, 0, 0);
        
        if (messageDate > now) {
            messageDate.setDate(messageDate.getDate() - 1);
        }
        
        return messageDate.getTime();
    } catch (error) {
        console.error('Error parsing message time:', error);
        return null;
    }
}

// Only add socket event listener if socket exists
if (socket) {
    socket.on('cleanup_old_messages', function() {
        cleanupOldMessages();
    });
}

setInterval(cleanupOldMessages, 60 * 60 * 1000);

function checkTimerState() {
    const isTimerRunning = localStorage.getItem('gameTimerRunning') === 'true';
    const usernameOverlay = document.getElementById('usernameOverlay');
    const usernameForm = document.getElementById('usernameForm');
    
    if (isTimerRunning && usernameOverlay && usernameForm) {
        usernameForm.innerHTML = `
            <h3>‚è∞ Game Timer Active</h3>
            <div class="timer-display" id="blockedTimerDisplay">Checking...</div>
            <div class="waiting-message">
                Please wait for the game timer to finish before joining the chat.
            </div>
            <button class="refresh-btn" onclick="checkTimerState()">Check Again</button>
            <div class="form-note">
                The chat will open automatically when the timer ends.
            </div>
        `;
        
        updateBlockedTimerDisplay();
        
        const timerCheckInterval = setInterval(() => {
            const stillRunning = localStorage.getItem('gameTimerRunning') === 'true';
            if (!stillRunning) {
                clearInterval(timerCheckInterval);
                location.reload();
            }
            updateBlockedTimerDisplay();
        }, 5000);
    }
}

function updateBlockedTimerDisplay() {
    const countdownElement = document.getElementById('blockedTimerDisplay');
    if (countdownElement) {
        const countdown = localStorage.getItem('gameCountdown') || 'Timer running...';
        countdownElement.textContent = countdown;
    }
}

// Initialize when page loads
window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>