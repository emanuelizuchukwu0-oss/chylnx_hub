<!-- Winner Modal -->
<div id="winnerModal">
  <div class="winner-modal-content">
    <h2>üéâ Winner Selected! üéâ</h2>
    <p id="winnerMessage">THE WINNER IS: <span id="winnerName"></span></p>
    <button onclick="closeWinnerModal()">Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let myUsername = "";
  let socket = null;
  let selectedWinner = null;
  const ANNOUNCE_PASSCODE = "1234"; // change to your secret

  // Initialize app
  function initApp() {
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', handleKeyPress);
    document.getElementById('bell').addEventListener('click', announceWinner);
    document.getElementById('usernameInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') setUsername();
    });
    document.getElementById('usernameOverlay').style.display = 'flex';
    document.getElementById('usernameInput').focus();
  }

  // Set username
  function setUsername() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (!username) return alert("Please enter a username");

    myUsername = username;
    document.getElementById('usernameOverlay').style.display = 'none';
    initializeChat();
  }

  // Initialize Socket.IO chat
  function initializeChat() {
    document.getElementById('chatInput').disabled = false;
    document.getElementById('sendBtn').disabled = false;

    socket = io();

    socket.emit('join_chat', { username: myUsername });

    socket.on('chat_history', function(history) {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.innerHTML = '<div class="system-msg">Welcome to the chat!</div>';
      history.forEach(msg => addMessage(msg, msg.from === myUsername));
    });

    socket.on('message', function(msg) {
      addMessage(msg, msg.from === myUsername);
    });

    socket.on('user_count_update', function(data) {
      document.getElementById('onlineCount').textContent = data.count + ' online';
    });

    socket.on('announcement', function(data) {
      addSystemMessage(data.text);
    });

    // üî• Winner announcement (modal popup for all users)
    socket.on("winner_announced", function(data) {
      const winners = Array.isArray(data.winners) ? data.winners.join(", ") : data.winners;
      document.getElementById("winnerName").textContent = winners;
      document.getElementById("winnerModal").style.display = "flex";

      // Disable chat input after winner announced
      document.getElementById("chatInput").disabled = true;
      document.getElementById("sendBtn").disabled = true;
    });

    addSystemMessage(`Welcome, ${myUsername}! Start chatting below.`);
    document.getElementById('chatInput').focus();
  }

  // Send message
  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !socket) return;

    socket.emit('message', { from: myUsername, text: text });
    input.value = '';
    input.focus();
  }

  function handleKeyPress(e) {
    if (e.key === 'Enter') sendMessage();
  }

  function addMessage(msg, isSent) {
    const chatWindow = document.getElementById('chatWindow');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

    const time = new Date(msg.timestamp).toLocaleTimeString([], { 
      hour: '2-digit', minute: '2-digit', hour12: true 
    });

    messageDiv.innerHTML = `
      ${!isSent ? `<div class="sender-name" onclick="selectWinner('${msg.from}')">${msg.from}</div>` : ''}
      <div class="message-content">${msg.text}</div>
      <div class="message-time">${time}</div>
    `;

    chatWindow.appendChild(messageDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addSystemMessage(text) {
    const chatWindow = document.getElementById('chatWindow');
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.textContent = text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // Winner selection
  function selectWinner(username) {
    if (username === myUsername) return alert("You can't select yourself!");
    selectedWinner = username;
    showWinnerModal(username);
  }

  function showWinnerModal(username) {
    document.getElementById('winnerName').textContent = username;
    document.getElementById('winnerModal').style.display = 'flex';
  }

  function closeWinnerModal() {
    document.getElementById('winnerModal').style.display = 'none';
  }

  function announceWinner() {
    if (!selectedWinner) return alert("Select a winner by clicking their name!");

    const entered = prompt("Enter passcode to announce the winner:");
    if (entered !== ANNOUNCE_PASSCODE) {
      alert("‚ùå Wrong passcode!");
      return;
    }

    socket.emit('announce_winner', { winners: [selectedWinner] });
    selectedWinner = null;
    closeWinnerModal();
  }

  window.addEventListener('DOMContentLoaded', initApp);
</script>
