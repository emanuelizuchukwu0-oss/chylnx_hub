<!DOCTYPE html>
<html>
<head>
    <title>Chylnx Hub Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Modern WhatsApp-like Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            height: 100vh;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Fixed Header Styles */
        header {
            background: #25D366;
            color: white;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(50px, 12vw, 60px);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 15px);
        }

        .header-info h2 {
            font-size: clamp(16px, 4vw, 20px);
        }

        .header-actions {
            display: flex;
            gap: clamp(15px, 3vw, 20px);
            font-size: clamp(16px, 4vw, 18px);
        }

        /* Chat Container */
        #chatContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path fill="%23007bff" d="M30,30 Q50,10 70,30 Q90,50 70,70 Q50,90 30,70 Q10,50 30,30 Z"/></svg>');
            background-color: #e5ddd5;
            margin-top: clamp(50px, 12vw, 60px); /* Header height */
            margin-bottom: clamp(60px, 15vw, 70px); /* Input area height */
            height: calc(100vh - clamp(50px, 12vw, 60px) - clamp(60px, 15vw, 70px));
        }

        #chatWindow {
            flex: 1;
            padding: clamp(15px, 3vw, 20px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 2vw, 8px);
            height: 100%;
        }

        /* Message Styles */
        .message {
            max-width: min(70%, 400px);
            padding: clamp(6px, 2vw, 8px) clamp(10px, 2vw, 12px);
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: #dcf8c6;
            border-top-right-radius: 0;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
        }

        .message-content {
            margin-bottom: 2px;
            line-height: 1.4;
            font-size: clamp(14px, 3vw, 16px);
            word-break: break-word;
        }

        .message-time {
            font-size: clamp(10px, 2vw, 11px);
            color: #667781;
            text-align: right;
            margin-top: 2px;
        }

        .message.received .message-time {
            text-align: left;
        }

        .sender-name {
            font-weight: 600;
            color: #25D366;
            font-size: clamp(11px, 2.5vw, 13px);
            margin-bottom: 2px;
            cursor: pointer;
        }

        .sender-name:hover {
            text-decoration: underline;
        }

        .selected-sender .sender-name {
            background: rgba(37, 211, 102, 0.2);
            padding: 2px 6px;
            border-radius: 12px;
        }

        /* Fixed Input Area */
        #inputArea {
            background: #f0f0f0;
            padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            border-top: 1px solid #d1d7db;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(60px, 15vw, 70px);
            z-index: 100;
        }

        #chatInput {
            flex: 1;
            padding: clamp(10px, 2vw, 12px) clamp(12px, 3vw, 16px);
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: clamp(14px, 3vw, 15px);
            background: white;
            min-width: 0; /* Prevents flex item overflow */
        }

        #sendBtn {
            background: #25D366;
            border: none;
            border-radius: 50%;
            width: clamp(35px, 10vw, 40px);
            height: clamp(35px, 10vw, 40px);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: clamp(14px, 3vw, 16px);
            flex-shrink: 0;
        }

        #sendBtn:hover {
            background: #20bd5a;
        }

        #sendBtn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }

        /* System Messages */
        .system-msg {
            text-align: center;
            color: #667781;
            font-size: clamp(12px, 2.5vw, 13px);
            margin: clamp(8px, 2vw, 10px) 0;
            font-style: italic;
        }

        /* Winner Announcement */
        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            text-align: center;
            padding: clamp(10px, 2vw, 12px);
            font-weight: bold;
            margin: clamp(8px, 2vw, 10px) 0;
            border-radius: 8px;
            animation: winnerPulse 2s infinite;
            font-size: clamp(14px, 3vw, 16px);
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Overlays */
        #usernameOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667781 0%, #25D366 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #usernameForm {
            background: white;
            padding: clamp(25px, 6vw, 40px);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: min(400px, 95vw);
            margin: 20px;
        }

        #usernameForm h3 {
            margin-bottom: clamp(15px, 3vw, 20px);
            color: #333;
            font-size: clamp(18px, 4vw, 22px);
        }

        #usernameForm input {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: clamp(15px, 3vw, 20px);
            outline: none;
            transition: border-color 0.3s;
        }

        #usernameForm input:focus {
            border-color: #25D366;
        }

        #usernameForm button {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            cursor: pointer;
            transition: background 0.3s;
        }

        #usernameForm button:hover {
            background: #20bd5a;
        }

        .form-note {
            margin-top: clamp(15px, 3vw, 20px);
            color: #666;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        /* Scrollbar Styling */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }

        #chatWindow::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatWindow::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 3px;
        }

        /* Winner Selection Modal */
        #winnerModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .winner-modal-content {
            background: white;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 15px;
            text-align: center;
            max-width: min(400px, 90vw);
            margin: 20px;
        }

        .winner-modal-content h2 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 15px;
        }

        .winner-modal-content p {
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 20px;
        }

        .winner-modal-content button {
            padding: clamp(8px, 2vw, 10px) clamp(15px, 3vw, 20px);
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
        }

        /* Winner Announcement Overlay */
        #winnerAnnouncementOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            animation: fadeIn 0.5s ease-in;
        }

        .winner-announcement-content {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            padding: clamp(30px, 6vw, 50px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5);
            max-width: min(500px, 90vw);
            width: 100%;
            animation: scaleUp 0.5s ease-out, glow 2s infinite alternate;
            border: 3px solid #fff;
        }

        @keyframes scaleUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes glow {
            from { box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 10px 70px rgba(255, 215, 0, 0.8); }
        }

        .winner-announcement-content h2 {
            font-size: clamp(24px, 6vw, 36px);
            color: #000;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .winner-announcement-content p {
            font-size: clamp(20px, 5vw, 28px);
            color: #000;
            font-weight: bold;
            margin: 20px 0;
        }

        .winner-announcement-content .winner-trophy {
            font-size: clamp(40px, 10vw, 60px);
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 480px) {
            .message {
                max-width: 85%;
            }
            
            #chatWindow {
                padding: 12px 10px;
            }
            
            .header-info {
                gap: 8px;
            }
            
            .header-actions {
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 80%;
            }
        }

        /* Large screen optimizations */
        @media (min-width: 1200px) {
            #chatContainer {
                margin-top: 60px;
                margin-bottom: 70px;
            }
            
            header {
                padding: 10px 16px;
                height: 60px;
            }
            
            #inputArea {
                padding: 10px 16px;
                height: 70px;
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            .message {
                max-width: 90%;
            }
            
            #usernameForm {
                padding: 20px 15px;
            }
        }

        /* Prevent horizontal scrolling */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Multiple Winner Selection Styles */
.winner-selection-panel {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 300px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    z-index: 2000;
    display: none;
    max-height: 400px;
    overflow-y: auto;
}

.winner-panel-header {
    background: #25D366;
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.winner-panel-header h3 {
    margin: 0;
    font-size: 16px;
}

.winner-list {
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.winner-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}

.winner-item:hover {
    background: #f5f5f5;
}

.winner-item.selected {
    background: #e3f2fd;
}

.winner-checkbox {
    margin-right: 10px;
}

.winner-actions {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
}

.winner-actions button {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#confirmWinners {
    background: #25D366;
    color: white;
}

#cancelWinners {
    background: #f0f0f0;
    color: #333;
}

.selected-count {
    background: #ffd700;
    color: #000;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 10px;
}

/* Selected username highlight in chat */
.username-selected {
    background: rgba(255, 215, 0, 0.3) !important;
    padding: 2px 6px;
    border-radius: 12px;
}
/* Timer Block Message Styles */
#usernameForm .timer-display {
    font-size: 2rem;
    color: #25D366;
    font-weight: bold;
    margin: 10px 0;
    text-shadow: 0 0 10px rgba(37, 211, 102, 0.5);
}

#usernameForm .waiting-message {
    color: #666;
    margin: 15px 0;
    line-height: 1.4;
}

#usernameForm .refresh-btn {
    width: 100%;
    padding: 12px;
    background: #25D366;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}

#usernameForm .refresh-btn:hover {
    background: #20bd5a;
}
    </style>
<head>
    <!-- Your existing head content (title, styles, etc.) -->
</head>
<body data-paid="false">
    <!-- Multiple Winner Selection Panel -->
    <div id="winnerSelectionPanel" class="winner-selection-panel">
        <div class="winner-panel-header">
            <h3>Select Winners <span id="selectedCount" class="selected-count">0</span></h3>
            <span onclick="closeWinnerPanel()" style="cursor: pointer; font-size: 18px;">×</span>
        </div>
        <div class="winner-list" id="winnerList">
            <!-- Winner list will be populated dynamically -->
        </div>
        <div class="winner-actions">
            <button id="cancelWinners" onclick="closeWinnerPanel()">Cancel</button>
            <button id="confirmWinners" onclick="announceSelectedWinners()">Announce Winners</button>
        </div>
    </div>

    <!-- Username Form Overlay -->
    <div id="usernameOverlay">
        <div id="usernameForm">
            <h3>Join the Chat</h3>
            <input type="text" id="usernameInput" placeholder="Enter your username" autocomplete="off">
            <button onclick="setUsername()">Start Chatting</button>
            <div class="form-note">
                Choose a cool name to get started!
            </div>
        </div>
    </div>

    <!-- Fixed Header -->
    <header>
        <div class="header-info">
            <h2>💬 Chylnx Chat</h2>
           <span id="onlineCount">Loading...</span>
        </div>
        <div class="header-actions">
            <span id="bell" title="Announce Winner">🔔</span>
        </div>
    </header>

    <!-- Chat Container -->
    <div id="chatContainer">
        <div id="chatWindow">
            <div class="system-msg">Welcome to the chat! Type a message to begin.</div>
        </div>
    </div>

    <!-- Fixed Input Area -->
    <div id="inputArea">
        <input id="chatInput" type="text" placeholder="Type a message..." disabled>
        <button id="sendBtn" disabled>➤</button>
    </div>

    <!-- Winner Modal -->
    <div id="winnerModal">
        <div class="winner-modal-content">
            <h2>🎉 Winner Selected! 🎉</h2>
            <p id="winnerMessage">THE WINNER IS: <span id="winnerName"></span></p>
            <button onclick="closeWinnerModal()">Close</button>
        </div>
    </div>

    <!-- Winner Announcement Overlay -->
    <div id="winnerAnnouncementOverlay">
        <div class="winner-announcement-content">
            <div class="winner-trophy">🏆</div>
            <h2>WINNER ANNOUNCED!</h2>
            <p>CONGRATULATIONS TO:</p>
            <p id="announcedWinnerName" style="font-size: clamp(24px, 6vw, 32px); color: #000; font-weight: bold;"></p>
            <p style="margin-top: 20px; font-size: clamp(14px, 3vw, 18px);">This announcement will close automatically</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
let myUsername = "";
let socket = null;
let selectedWinners = [];
let onlineUsers = [];
let isGameStarted = false; // Track if game has started
const ANNOUNCE_PASSCODE = "1234";

// Initialize app
function initApp() {
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('bell').addEventListener('click', showWinnerSelectionPanel);
    document.getElementById('usernameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') setUsername();
    });

    // Add click event to close overlay when clicking outside content
    document.getElementById('winnerAnnouncementOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });

    // Show username overlay immediately but check timer status
    document.getElementById('usernameOverlay').style.display = 'flex';
    checkTimerStatus();
    
    // Focus on username input
    document.getElementById('usernameInput').focus();
}
// Check timer status from server (ONLY checks original game timer)
function checkTimerStatus() {
    // Create a temporary socket connection to check timer status
    const tempSocket = io();
    
    tempSocket.on('connect', function() {
        console.log('⏰ Checking game timer status...');
        // Request current game timer state (NOT weekly challenge)
        tempSocket.emit('get_timer');
    });
    
    tempSocket.on('timer_update', function(data) {
        console.log('📡 Game timer status received:', data);
        
        if (data.is_running && data.remaining_seconds > 0) {
            // Game timer is still running - block username entry
            showTimerBlockMessage(data.remaining_seconds);
        } else {
            // Game timer has stopped - allow username entry
            isGameStarted = true;
            enableUsernameEntry();
        }
        
        // Close temporary connection
        tempSocket.disconnect();
    });
    
    tempSocket.on('game_started', function(data) {
        console.log('🎉 Game started - allowing username entry');
        isGameStarted = true;
        enableUsernameEntry();
        tempSocket.disconnect();
    });
    
    // Handle connection errors
    tempSocket.on('connect_error', function(error) {
        console.error('❌ Connection error:', error);
        // If we can't connect to timer, assume game has started
        isGameStarted = true;
        enableUsernameEntry();
    });
}
// Show message when timer is still running
function showTimerBlockMessage(remainingSeconds) {
    const usernameForm = document.getElementById('usernameForm');
    const minutes = Math.floor(remainingSeconds / 60);
    const seconds = remainingSeconds % 60;
    
    usernameForm.innerHTML = `
        <h3>⏰ Game Starting Soon</h3>
        <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 2rem; color: #25D366; font-weight: bold; margin: 10px 0;">
                ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
            </div>
            <p style="color: #666; margin: 15px 0;">
                Please wait for the timer to finish before joining the chat.
            </p>
            <p style="color: #888; font-size: 0.9rem;">
                Game will start automatically when timer reaches zero.
            </p>
        </div>
        <button onclick="checkTimerStatus()" style="width: 100%; padding: 12px; background: #25D366; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
            Refresh Status
        </button>
        <div class="form-note">
            You'll be able to join when the game starts
        </div>
    `;
}

// Enable username entry when game starts
function enableUsernameEntry() {
    const usernameForm = document.getElementById('usernameForm');
    usernameForm.innerHTML = `
        <h3>Join the Chat</h3>
        <input type="text" id="usernameInput" placeholder="Enter your username" autocomplete="off">
        <button onclick="setUsername()">Start Chatting</button>
        <div class="form-note">
            Choose a cool name to get started!
        </div>
    `;
    
    // Re-attach event listeners
    document.getElementById('usernameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') setUsername();
    });
    
    document.getElementById('usernameInput').focus();
}

// Set username
function setUsername() {
    if (!isGameStarted) {
        alert("Please wait for the game to start before joining the chat.");
        return;
    }
    
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (!username) return alert("Please enter a username");

    myUsername = username;
    document.getElementById('usernameOverlay').style.display = 'none';
    initializeChat();
}

// Initialize Socket.IO chat
function initializeChat() {
    document.getElementById('chatInput').disabled = false;
    document.getElementById('sendBtn').disabled = false;

    socket = io(); // connect to server    

    // Join chat
    socket.emit('join_chat', { username: myUsername });

    // Receive chat history
    socket.on('chat_history', function(history) {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.innerHTML = '<div class="system-msg">Welcome to the chat!</div>';
        history.forEach(msg => addMessage(msg, msg.from === myUsername));
    });

    // ✅ FIXED: Listen for new messages with correct event name
    socket.on('new_message', function(data) {
        console.log('📨 Received new message:', data);
        const isSent = data.from === myUsername;
        addMessage(data, isSent);
    });

    // ✅ FIXED: Add error handling
    socket.on('message_error', function(data) {
        console.error('❌ Message error:', data.error);
        alert('Failed to send message: ' + data.error);
    });

    // Online count
    socket.on('user_count_update', function(data) {
        document.getElementById('onlineCount').textContent = data.count + ' online';
        
        // Update online users list for winner selection
        updateOnlineUsersList();
    });

    // Winner announcements
    socket.on('announcement', function(data) {
        addSystemMessage(data.text);
    });

    // Winner announced from server (for all users)
    socket.on('winner_announced', function(data) {
        console.log('🎉 Received winner announcement:', data);
        
        const winners = Array.isArray(data.winners) ? data.winners.join(", ") : data.winners;
        
        // Show the announcement overlay for EVERY user
        showWinnerAnnouncement(winners);
        
        // Also add system message to chat
        addSystemMessage(`🏆 WINNER ANNOUNCEMENT: ${winners}! Congratulations! 🎉`);
        
        // Optional: Disable chat input temporarily
        document.getElementById("chatInput").disabled = true;
        document.getElementById("sendBtn").disabled = true;
        
        // Re-enable after overlay closes (optional)
        setTimeout(() => {
            document.getElementById("chatInput").disabled = false;
            document.getElementById("sendBtn").disabled = false;
        }, 10000);
    });

    // Listen for game started events in case admin starts new timer
    socket.on('game_started', function(data) {
        console.log('🎉 Game started event received in chat');
        isGameStarted = true;
    });

    // Listen for timer updates in case admin sets new timer
    socket.on('timer_update', function(data) {
        if (data.is_running && data.remaining_seconds > 0) {
            // Timer started again - block new users from joining
            isGameStarted = false;
        } else {
            // Timer stopped - allow new users
            isGameStarted = true;
        }
    });

    addSystemMessage(`Welcome, ${myUsername}! Start chatting below.`);
    
    // Focus on chat input
    document.getElementById('chatInput').focus();
}

// Update online users list from connected_users (you'll need to get this from your server)
function updateOnlineUsersList() {
    // This would typically come from a socket event that sends the list of online users
    // For now, we'll extract from the chat messages
    const users = new Set();
    const messages = document.querySelectorAll('.message .sender-name');
    messages.forEach(msg => {
        if (msg.textContent && msg.textContent !== myUsername) {
            users.add(msg.textContent);
        }
    });
    onlineUsers = Array.from(users);
}

// Show winner selection panel
function showWinnerSelectionPanel() {
    const panel = document.getElementById('winnerSelectionPanel');
    const winnerList = document.getElementById('winnerList');
    
    // Populate winner list
    winnerList.innerHTML = '';
    
    // Add current online users (you might want to get this from a socket event)
    onlineUsers.forEach(user => {
        if (user !== myUsername) {
            const winnerItem = document.createElement('div');
            winnerItem.className = `winner-item ${selectedWinners.includes(user) ? 'selected' : ''}`;
            winnerItem.innerHTML = `
                <input type="checkbox" class="winner-checkbox" ${selectedWinners.includes(user) ? 'checked' : ''} value="${user}">
                <span>${user}</span>
            `;
            winnerItem.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('.winner-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleWinnerSelection(user, checkbox.checked);
                }
            });
            winnerList.appendChild(winnerItem);
        }
    });
    
    // Add click event for checkboxes
    winnerList.querySelectorAll('.winner-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleWinnerSelection(this.value, this.checked);
        });
    });
    
    updateSelectedCount();
    panel.style.display = 'block';
}

// Close winner selection panel
function closeWinnerPanel() {
    document.getElementById('winnerSelectionPanel').style.display = 'none';
}

// Toggle winner selection
function toggleWinnerSelection(username, isSelected) {
    if (isSelected) {
        if (!selectedWinners.includes(username)) {
            selectedWinners.push(username);
        }
    } else {
        selectedWinners = selectedWinners.filter(user => user !== username);
    }
    
    // Update UI
    updateSelectedCount();
    highlightSelectedUsers();
}

// Update selected count display
function updateSelectedCount() {
    const countElement = document.getElementById('selectedCount');
    countElement.textContent = selectedWinners.length;
}

// Highlight selected users in chat
function highlightSelectedUsers() {
    // Remove all highlights first
    document.querySelectorAll('.sender-name').forEach(name => {
        name.classList.remove('username-selected');
    });
    
    // Add highlight to selected users
    selectedWinners.forEach(username => {
        document.querySelectorAll('.sender-name').forEach(name => {
            if (name.textContent === username) {
                name.classList.add('username-selected');
            }
        });
    });
}

// Announce selected winners
function announceSelectedWinners() {
    if (selectedWinners.length === 0) {
        alert("Please select at least one winner!");
        return;
    }
    
    const entered = prompt("Enter passcode to announce the winners:");
    if (entered !== ANNOUNCE_PASSCODE) {
        alert("❌ Wrong passcode! You are not allowed to announce.");
        return;
    }

    // Show the announcement overlay immediately
    showWinnerAnnouncement(selectedWinners.join(', '));
    
    // Emit to server (broadcast to all users)
    socket.emit('announce_winner', { winners: selectedWinners });

    // Clear selection
    selectedWinners = [];
    closeWinnerPanel();
    highlightSelectedUsers();
}

// Handle Enter key in input
function handleKeyPress(e) {
    if (e.key === 'Enter') sendMessage();
}

// ✅ FIXED: Send message function
function sendMessage() {
    const messageInput = document.getElementById('chatInput');
    const text = messageInput.value.trim();
    
    if (text) {
        console.log('📤 Sending message:', text);
        socket.emit('message', {
            text: text
        });
        messageInput.value = ''; // Clear input
        messageInput.focus(); // Keep focus on input
    } else {
        alert('Please enter a message');
    }
}
// Add message to chat window
function addMessage(msg, isSent) {
    const chatWindow = document.getElementById('chatWindow');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

    const time = new Date(msg.timestamp).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: true 
    });

    const isSelected = selectedWinners.includes(msg.from);

    messageDiv.innerHTML = `
        ${!isSent ? `<div class="sender-name ${isSelected ? 'username-selected' : ''}" onclick="toggleUserSelection('${msg.from}')">${msg.from}</div>` : ''}
        <div class="message-content">${msg.text}</div>
        <div class="message-time">${time}</div>
    `;

    chatWindow.appendChild(messageDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    
    // Add to online users if not already there
    if (!isSent && !onlineUsers.includes(msg.from) && msg.from !== myUsername) {
        onlineUsers.push(msg.from);
    }
}

// Toggle user selection when clicking on username in chat
function toggleUserSelection(username) {
    if (username === myUsername) return;
    
    const isSelected = selectedWinners.includes(username);
    if (isSelected) {
        selectedWinners = selectedWinners.filter(user => user !== username);
    } else {
        selectedWinners.push(username);
    }
    
    highlightSelectedUsers();
    updateSelectedCount();
}

// System messages
function addSystemMessage(text) {
    const chatWindow = document.getElementById('chatWindow');
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.textContent = text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// New function to show winner announcement overlay
function showWinnerAnnouncement(usernames) {
    const overlay = document.getElementById('winnerAnnouncementOverlay');
    const winnerNameElement = document.getElementById('announcedWinnerName');
    
    winnerNameElement.textContent = usernames;
    overlay.style.display = 'flex';
    
    // Auto-close after 10 seconds
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 10000);
}

window.addEventListener('DOMContentLoaded', initApp);
// Add debug listeners
socket.on('new_message', function(data) {
    console.log('📨 Received new message:', data);
    addMessageToChat(data);
});

socket.on('message_error', function(data) {
    console.error('❌ Message error:', data.error);
    alert('Failed to send message: ' + data.error);
});

socket.on('connect', function() {
    console.log('✅ Connected to server');
});

socket.on('disconnect', function() {
    console.log('❌ Disconnected from server');
});

// In initializeChat() function, REPLACE the conflicting message listeners with:
socket.on('new_message', function(data) {
    console.log('📨 Received new message:', data);
    const isSent = data.from === myUsername;
    addMessage(data, isSent);
});

socket.on('message_error', function(data) {
    console.error('❌ Message error:', data.error);
    alert('Failed to send message: ' + data.error);
});

    </script>
</body>
</html>